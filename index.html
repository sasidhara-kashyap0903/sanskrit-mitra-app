
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanskrit Mitra - Your Personal Tutor</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="./public/output.css" rel="stylesheet">
    <link rel="stylesheet" href="/src/index.css">

    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        // Set worker source for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .font-devanagari { font-family: 'Noto Sans Devanagari', sans-serif; }
        .animate-blob { animation: blob 7s infinite; }
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(107, 114, 128, 0.5); border-radius: 10px; }
        .mic-listening { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        #chat-screen, #chatbot-container, #login-screen, #dashboard-screen {
            height: 100vh;
        }
        #history-sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .chat-item-actions {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .chat-item:hover .chat-item-actions {
            opacity: 1;
        }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .chevron { transform: rotate(90deg); }
        .voice-option:has(input:checked) {
            border-color: #0891b2; /* cyan-600 */
            background-color: rgba(14, 165, 233, 0.1);
        }
        
        /* --- Modern UI Enhancements --- */
        #chatbot-container, #dashboard-screen {
            background-image: linear-gradient(to bottom right, hsl(222 47% 11%), hsl(221 39% 20%));
        }
        .message-bubble {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s ease-out;
        }
        .user-bubble {
            background-image: linear-gradient(to bottom right, #0891b2, #0d9488);
        }
        .bot-bubble {
            background-color: #374151; /* gray-700 */
        }
        #input-area {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(to top, rgba(0,0,0,0.2), transparent);
        }
        @keyframes message-enter {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .message-enter {
            animation: message-enter 0.3s ease-out;
        }

        /* Table Styles */
        .sanskrit-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .sanskrit-table th, .sanskrit-table td {
            border: 1px solid rgb(55 65 81); /* gray-700 */
            padding: 8px 12px;
            text-align: left;
        }
        .sanskrit-table th {
            background-color: rgb(31 41 55); /* gray-800 */
            font-weight: 600;
        }
        .sanskrit-table tr:nth-child(even) {
            background-color: rgba(55, 65, 81, 0.5); /* gray-700 with opacity */
        }
        
        /* Quiz Styles */
        .quiz-option.correct, .quiz-option-multi.correct {
            background-color: #10b981; /* Emerald-500 */
            border-color: #059669;
            color: white;
        }
        .quiz-option.incorrect, .quiz-option-multi.incorrect {
            background-color: #ef4444; /* Red-500 */
            border-color: #dc2626;
            color: white;
        }
        .quiz-option:disabled, .quiz-option-multi:disabled {
            cursor: not-allowed;
        }
        .quiz-setup-option:has(input:checked) {
            border-color: #0891b2;
            background-color: rgba(14, 165, 233, 0.1);
        }
        .matching-item.correct {
            background-color: rgba(16, 185, 129, 0.2);
        }
        .matching-item.incorrect {
             background-color: rgba(239, 68, 68, 0.2);
        }
        .review-question-item.correct { border-left-color: #10b981; }
        .review-question-item.incorrect { border-left-color: #ef4444; }

        /* Achievement Badge Styles */
        .achievement-badge.locked {
            filter: grayscale(100%);
            opacity: 0.5;
        }

        /* Light Theme Styles */
        .light body { background-color: #f9fafb; color: #1f2937; }
        .light #login-screen, .light #chat-screen, .light #dashboard-screen { background-color: #f9fafb; }
        .light #history-sidebar { background-color: #ffffff; border-color: #e5e7eb; }
        .light #chatbot-container, .light #dashboard-screen {
            background-image: linear-gradient(to bottom right, #ffffff, #f3f4f6);
        }
        .light .user-bubble {
            background-image: linear-gradient(to bottom right, #06b6d4, #14b8a6);
            color: white;
        }
        .light .bot-bubble {
            background-color: #ffffff;
            color: #1f2937;
            border: 1px solid #e5e7eb;
        }
        .light .message-bubble {
             box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0,0,0,0.05);
        }
        .light #input-area {
            border-top: 1px solid #e5e7eb;
            background: linear-gradient(to top, rgba(0,0,0,0.02), transparent);
        }
        .light .border-cyan-500\/30 { border-color: #e5e7eb; }
        .light .bg-gray-800 { background-color: #f3f4f6; }
        .light #input-field, .light #image-gen-prompt, .light .task-input { color: #1f2937; }
        .light #input-field::placeholder, .light #image-gen-prompt::placeholder, .light .task-input::placeholder { color: #6b7280; }
        .light .text-gray-400 { color: #6b7280; }
        .light .hover\:bg-gray-700:hover { background-color: #e5e7eb; }
        .light .text-gray-300 { color: #4b5563; }
        .light .chat-item:hover { background-color: #f3f4f6; }
        .light .chat-item[data-chat-id].bg-cyan-500\/20 { background-color: rgba(14, 165, 233, 0.1); }
        .light .bg-gray-900 { background-color: #ffffff; }
        .light .bg-gray-700 { background-color: #e5e7eb; }
        .light .text-white { color: #1f2937; }
        .light #send-btn .text-white, .light #stop-btn .text-white, .light #new-chat-btn .text-white, .light #login-btn .text-white, .light #modal-confirm-btn .text-white, .light #modal-cancel-btn .text-white, .light #start-new-chat-btn .text-white, .light #image-gen-submit-btn .text-white, .light #save-task-btn .text-white { color: #ffffff; }
        .light .bg-gray-600 { background-color: #9ca3af; }
        .light .hover\:bg-gray-500:hover { background-color: #6b7280; }
        .light .bg-gray-900\/90 { background-color: rgba(255, 255, 255, 0.9); }
        .light .bg-gray-900\/80 { background-color: rgba(249, 250, 251, 0.8); }
        .light .text-gray-500 { color: #6b7280; }
        .light .border-cyan-500\/20 { border-color: rgba(14, 165, 233, 0.2); }
        .light .bg-cyan-500\/20 { background-color: rgba(14, 165, 233, 0.1); }
        .light .bg-gray-800 .text-white { color: #1f2937; }
        .light .bg-gray-700 .text-white { color: #111827; }
        .light #confirmation-modal .bg-gray-800, .light #voice-modal .bg-gray-800, .light #lesson-selection-modal .bg-gray-800, .light #lesson-modal .bg-gray-800, .light #quiz-modal .bg-gray-800, .light #quiz-setup-modal .bg-gray-800, .light #image-gen-modal .bg-gray-800, .light #achievements-modal .bg-gray-800, .light #task-scheduler-modal .bg-gray-800 { background-color: #ffffff; }
        .light #confirmation-modal .text-white, .light #voice-modal .text-white, .light #lesson-selection-modal .text-white, .light #lesson-modal .text-white, .light #quiz-modal .text-white, .light #quiz-setup-modal .text-white, .light #image-gen-modal .text-white, .light #achievements-modal .text-white, .light #task-scheduler-modal .text-white { color: #1f2937; }
        .light .voice-option { background-color: #f3f4f6; }
        .light .voice-option:has(input:checked) { background-color: rgba(14, 165, 233, 0.1); }
        .light .bg-gray-700\/50 { background-color: rgba(229, 231, 235, 0.5); }
        .light .hover\:bg-red-500\/10:hover { background-color: rgba(239, 68, 68, 0.1); }
        .light .bg-gray-900\/50 { background-color: rgba(255, 255, 255, 0.8); }
        .light .border-gray-700 { border-color: #d1d5db; }
        .light .bg-clip-text { color: #0891b2; }
        .light .sanskrit-table th, .light .sanskrit-table td { border-color: #e5e7eb; }
        .light .sanskrit-table th { background-color: #f3f4f6; }
        .light .sanskrit-table tr:nth-child(even) { background-color: #f9fafb; }
        .light .quiz-option.correct, .light .quiz-option-multi.correct { background-color: #d1fae5; border-color: #6ee7b7; color: #065f46; }
        .light .quiz-option.incorrect, .light .quiz-option-multi.incorrect { background-color: #fee2e2; border-color: #fca5a5; color: #991b1b; }
        .light .quiz-setup-option { background-color: #f3f4f6; }
        .light .quiz-setup-option:has(input:checked) { background-color: rgba(14, 165, 233, 0.1); }
        .light .matching-item.correct { background-color: #d1fae5; }
        .light .matching-item.incorrect { background-color: #fee2e2; }
        .light .review-question-item { background-color: #ffffff; }
        .light .review-question-item.correct { border-left-color: #10b981; }
        .light .review-question-item.incorrect { border-left-color: #ef4444; }
        .light #tools-menu-dropdown { background-color: #ffffff; border-color: #e5e7eb; }
        .light #tools-menu-dropdown button { color: #4b5563; }
        .light #tools-menu-dropdown button:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-900 text-white transition-colors duration-300">
    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyDcSBGY5uRf5-KSS8qCL7uyiN0bdG7HCFc",
  authDomain: "sasnkrit-mitra-app.firebaseapp.com",
  projectId: "sasnkrit-mitra-app",
  storageBucket: "sasnkrit-mitra-app.firebasestorage.app",
  messagingSenderId: "930289396247",
  appId: "1:930289396247:web:043e7c1b95434f69b94a52",
  measurementId: "G-R3C6VFLPSR"
};
        // This makes the config available to the main script
        const __firebase_config = JSON.stringify(firebaseConfig);
    </script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, getDocs, writeBatch, updateDoc, query, orderBy, deleteDoc, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken,
            signOut,
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            onSnapshot,
            collection,
            addDoc,
            serverTimestamp,
            getDocs,
            writeBatch,
            query,
            orderBy,
            deleteDoc,
            where,
            Timestamp,
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        };
    </script>

    <div class="h-screen flex flex-col relative overflow-hidden">
        <!-- Background decorative blobs -->
        <div class="absolute inset-0 z-0 opacity-50">
            <div class="absolute top-0 -left-4 w-72 h-72 bg-cyan-600 rounded-full mix-blend-lighten filter blur-3xl animate-blob"></div>
            <div class="absolute top-0 -right-4 w-72 h-72 bg-purple-600 rounded-full mix-blend-lighten filter blur-3xl animate-blob animation-delay-2000"></div>
            <div class="absolute bottom-0 left-20 w-72 h-72 bg-pink-600 rounded-full mix-blend-lighten filter blur-3xl animate-blob animation-delay-4000"></div>
        </div>
        
        <!-- Login Screen -->
        <div id="login-screen" class="relative z-10 flex flex-col justify-center items-center p-4 text-center">
            <h1 class="text-4xl sm:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-purple-500">Welcome to Sanskrit Mitra</h1>
            <p class="mt-4 text-lg text-gray-300">Your personal AI tutor for learning Sanskrit.</p>
            <button id="login-btn" class="mt-8 px-8 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-semibold rounded-lg shadow-lg transition-colors">
                Login Anonymously
            </button>
        </div>

        <!-- Learning Dashboard Screen -->
        <main id="dashboard-screen" class="hidden relative z-10 flex flex-col">
             <div class="p-4 border-b border-cyan-500/30 flex-shrink-0 flex justify-between items-center">
                 <h1 id="dashboard-title" class="text-2xl font-bold text-cyan-400">Learning Dashboard</h1>
                 <div class="flex items-center gap-4">
                     <button id="switch-to-chat-btn" class="px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg shadow-lg hover:bg-cyan-500 transition-colors">
                        Chat with Mitra
                    </button>
                    <a href="https://wa.me/918500419303?text=Feedback%20for%20Sanskrit%20Mitra%20App%3A%20" target="_blank" class="p-2 rounded-full hover:bg-gray-700 transition-colors" title="Send Feedback on WhatsApp">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-green-500"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.905 6.344l-1.225 4.429 4.56-1.19zM9.072 8.411c-.024-.106-.157-.167-.327-.182-.17-.016-.372-.016-.572-.016-.2 0-.51.076-.733.372-.224.297-.867.851-.867 2.079 0 1.228.892 2.401 1.016 2.564.124.163 1.735 2.76 4.225 3.729 2.133.826 2.487.804 2.92.745.433-.059 1.393-.572 1.591-1.125.198-.553.198-1.024.137-1.125-.06-.101-.224-.162-.473-.287-.249-.125-1.467-.725-1.691-.804-.224-.08-.387-.125-.552.125-.164.25-.639.725-.785.876-.146.151-.292.162-.473.038-.182-.125-.767-.28-1.465-.902-.544-.474-.902-1.063-.982-1.227-.08-.164-.008-.25.117-.375.116-.116.249-.304.373-.429.116-.116.164-.2.249-.334.085-.134.038-.25-.016-.375-.053-.125-.473-1.138-.649-1.554z"/></svg>
                    </a>
                 </div>
             </div>
             <div id="modules-grid" class="flex-grow p-4 sm:p-8 grid grid-cols-1 gap-6 overflow-y-auto custom-scrollbar max-w-4xl mx-auto w-full">
                <!-- Module cards will be injected here -->
             </div>
        </main>

        <!-- Main Chat Screen (hidden by default) -->
        <main id="chat-screen" class="hidden relative z-10 flex flex-grow">
            <!-- History Sidebar -->
            <aside id="history-sidebar" class="absolute top-0 left-0 h-full w-5/6 sm:w-64 bg-gray-900/90 backdrop-blur-md z-30 transform -translate-x-full flex flex-col border-r border-cyan-500/20">
                <div class="p-4 flex-shrink-0">
                    <button id="new-chat-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg shadow-lg hover:bg-cyan-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        New Chat
                    </button>
                </div>
                <div class="p-2 flex-shrink-0">
                    <div class="relative">
                        <input id="search-chats-input" type="text" placeholder="Search chats..." class="w-full bg-gray-800 border border-gray-700 rounded-lg py-1.5 px-3 pl-8 text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-500"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    </div>
                </div>
                <div id="chat-history-list" class="flex-grow overflow-y-auto custom-scrollbar p-2">
                    <!-- Chat history items will be populated here -->
                </div>
                <div class="p-2 border-t border-cyan-500/20 flex-shrink-0">
                    <button id="delete-all-chats-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 text-sm text-red-500 hover:bg-red-500/10 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                        Delete All Chats
                    </button>
                </div>
            </aside>
            <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/50 z-20"></div>

            <!-- Chatbot Component -->
            <div id="chatbot-container" class="w-full bg-gray-900/80 backdrop-blur-sm flex flex-col h-full">
                
                <div class="p-4 border-b border-cyan-500/30 flex-shrink-0 flex justify-between items-center">
                    <div class="flex items-center gap-2 flex-shrink-0">
                         <button id="menu-btn" title="Toggle Menu" class="p-2 rounded-full hover:bg-gray-700 transition-colors" aria-label="Toggle Menu">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-white"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                        </button>
                        
                        <div class="relative" id="dashboard-menu-container">
                            <button id="dashboard-menu-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors flex items-center gap-1" title="Go to Dashboard">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-white"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-white"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                            <div id="dashboard-menu-dropdown" class="hidden absolute left-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg z-50 border border-cyan-500/20">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" data-course-id="course1">SAN Course I</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" data-course-id="course2">SAN Course II</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" data-course-id="course3">SAN Course III</a>
                            </div>
                        </div>

                        <button id="logout-btn" title="Logout" class="p-2 rounded-full hover:bg-gray-700 transition-colors" aria-label="Logout">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-white"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        </button>
                    </div>
                    <div class="text-center flex-shrink mx-2">
                        <div class="flex justify-center items-center gap-2">
                           <h2 class="text-xl font-bold text-cyan-400 truncate">Sanskrit Mitra</h2>
                           <span class="bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-0.5 rounded-full flex-shrink-0">Beta</span>
                        </div>
                        <p id="view-mode-indicator" class="text-sm text-gray-400 truncate">Your AI Sanskrit Companion</p>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <button id="theme-toggle-btn" title="Toggle Theme" class="p-2 rounded-full hover:bg-gray-700 transition-colors" aria-label="Toggle Theme">
                           <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-white hidden"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                           <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-white"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                        </button>
    
                        <div id="stop-audio-container" class="w-8 h-8"></div>
                    </div>
                </div>

                <div id="messages-container" class="flex-1 p-2 sm:p-4 overflow-y-auto space-y-4 custom-scrollbar">
                    <!-- Messages will be dynamically inserted here -->
                </div>
                 <div id="no-active-chat-screen" class="hidden flex-1 flex-col justify-center items-center text-center p-4">
                    <h3 class="text-2xl font-bold text-gray-300">No Active Chat</h3>
                    <p class="text-gray-500 mt-2">Start a new conversation to begin.</p>
                    <button id="start-new-chat-btn" class="mt-6 px-6 py-2 bg-cyan-600 text-white font-semibold rounded-lg shadow-lg hover:bg-cyan-500 transition-colors">
                        Start New Chat
                    </button>
                </div>

                <div id="input-area" class="p-2 sm:p-4 border-t border-cyan-500/30 flex-shrink-0">
                    <div id="file-preview-container" class="hidden relative w-full max-w-sm mb-2 p-2 border border-gray-600 rounded-lg bg-gray-800">
                        <div id="file-preview-content" class="flex items-center gap-2"></div>
                        <button id="remove-file-btn" title="Remove File" aria-label="Remove File" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full p-0.5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div class="flex items-center bg-gray-800 rounded-full p-1 sm:p-2 gap-1 sm:gap-2">
                        <!-- Add Files Button -->
                        <input type="file" id="file-input" class="hidden" accept="image/jpeg, image/png, image/jpg, application/pdf">
                        <button id="file-btn" title="Add Files" class="p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors flex-shrink-0" aria-label="Add Files">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>

                        <!-- Tools Menu -->
                        <div class="relative flex-shrink-0">
                            <button id="tools-menu-btn" title="Tools" class="flex items-center gap-1 p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors" aria-label="Open Tools Menu">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 4.8-4.8 1.9 4.8 1.9L12 21l1.9-4.8 4.8-1.9-4.8-1.9L12 3z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                                <span class="hidden sm:inline">Tools</span>
                            </button>
                            <div id="tools-menu-dropdown" class="hidden absolute bottom-full mb-2 w-56 bg-gray-900 border border-cyan-500/20 rounded-lg shadow-lg z-10 p-2">
                                <div class="space-y-1">
                                    <button id="guided-learning-btn" class="w-full flex items-center gap-3 p-2 text-left text-gray-300 rounded-md hover:bg-gray-700 transition-colors">
                                       <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 5 4 5 6 5s6-0 6-5v-5"/></svg>
                                       <span>Guided Learning</span>
                                    </button>
                                    <button id="schedule-task-btn" class="w-full flex items-center gap-3 p-2 text-left text-gray-300 rounded-md hover:bg-gray-700 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                        <span>Schedule Task</span>
                                    </button>
                                    <button id="achievements-btn" class="w-full flex items-center gap-3 p-2 text-left text-gray-300 rounded-md hover:bg-gray-700 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2"/><path d="M12 12h8l-3-3 3-3h-8V4h10v16H12z"/></svg>
                                        <span>My Achievements</span>
                                    </button>
                                    <button id="image-gen-btn" class="w-full flex items-center gap-3 p-2 text-left text-gray-300 rounded-md hover:bg-gray-700 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c.3 0 .5.1.8.3l4.5 3.5c.2.2.3.4.3.7v9c0 .3-.1.5-.3.8l-4.5 3.5c-.3.2-.5.3-.8.3s-.5-.1-.8-.3L6.7 20.3c-.2-.2-.3-.4-.3-.7v-9c0-.3.1-.5.3-.8l4.5-3.5c.3-.2.5-.3.8-.3z"/><path d="m9.5 14.5 2.5-3 2.5 3"/><path d="M12 11.5V16"/><path d="m8.5 8 2 2.5 2-2.5"/></svg>
                                        <span>Generate Image</span>
                                    </button>
                                    <button id="deep-think-btn" class="w-full flex items-center gap-3 p-2 text-left text-gray-300 rounded-md hover:bg-gray-700 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v0A2.5 2.5 0 0 1 9.5 7v0A2.5 2.5 0 0 1 7 9.5v0A2.5 2.5 0 0 1 4.5 12v0A2.5 2.5 0 0 1 7 14.5v0A2.5 2.5 0 0 1 9.5 17v0A2.5 2.5 0 0 1 12 19.5v0A2.5 2.5 0 0 1 14.5 17v0A2.5 2.5 0 0 1 17 14.5v0A2.5 2.5 0 0 1 19.5 12v0A2.5 2.5 0 0 1 17 9.5v0A2.5 2.5 0 0 1 14.5 7v0A2.5 2.5 0 0 1 12 4.5v0A2.5 2.5 0 0 1 9.5 2Z"/><path d="M12 12a2.5 2.5 0 0 0-2.5 2.5v0A2.5 2.5 0 0 0 12 17v0a2.5 2.5 0 0 0 2.5-2.5v0A2.5 2.5 0 0 0 12 12Z"/><path d="M12 4.5a2.5 2.5 0 0 0-2.5 2.5v0A2.5 2.5 0 0 0 12 9.5v0a2.5 2.5 0 0 0 2.5-2.5v0A2.5 2.5 0 0 0 12 4.5Z"/><path d="M17 9.5a2.5 2.5 0 0 0-2.5 2.5v0a2.5 2.5 0 0 0 2.5 2.5v0a2.5 2.5 0 0 0 2.5-2.5v0a2.5 2.5 0 0 0-2.5-2.5Z"/><path d="M7 9.5a2.5 2.5 0 0 0-2.5 2.5v0a2.5 2.5 0 0 0 2.5 2.5v0a2.5 2.5 0 0 0 2.5-2.5v0A2.5 2.5 0 0 0 7 9.5Z"/></svg>
                                        <span>Deep Think Mode</span>
                                    </button>
                                    <button id="export-chat-btn" class="w-full flex items-center gap-3 p-2 text-left text-gray-300 rounded-md hover:bg-gray-700 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                        <span>Export Chat</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Input Field -->
                        <div class="relative flex-1 mx-2">
                            <input id="input-field" type="text" placeholder="Enter a prompt for Mitra" class="w-full bg-transparent text-white placeholder-gray-500 focus:outline-none px-2 pr-8">
                            <button id="clear-input-btn" title="Clear Input" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white hidden" aria-label="Clear input"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                        </div>

                        <!-- Right side buttons -->
                        <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                            <button id="mic-btn" title="Use Microphone" class="p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors" aria-label="Use microphone"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg></button>
                            <button id="regenerate-btn" title="Regenerate Response" class="p-2 text-gray-400 rounded-lg hover:bg-gray-700 hover:text-white disabled:text-gray-600 disabled:bg-transparent disabled:cursor-not-allowed transition-colors hidden" aria-label="Regenerate response" disabled><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg></button>
                            <button id="send-btn" title="Send Message" class="p-2 bg-cyan-600 rounded-lg hover:bg-cyan-500 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors" aria-label="Send message" disabled><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="m22 2-7 20-4-9-9-4Z"/><path d="m22 2-11 11"/></svg></button>
                            <button id="stop-btn" title="Stop Generating" class="hidden p-2 bg-red-600 rounded-lg hover:bg-red-500" aria-label="Stop generating">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-white"><rect x="6" y="6" width="12" height="12"></rect></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="text-center text-xs text-gray-500 p-2 flex-shrink-0">
                    Sanskrit Mitra can make mistakes, so double-check it.
                </div>
            </div>
        </main>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
                <h3 id="modal-title" class="text-lg font-bold text-white">Confirm Action</h3>
                <p id="modal-body" class="text-gray-300 mt-2 mb-6">Are you sure you want to proceed?</p>
                <div class="flex justify-end gap-4">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 text-white hover:bg-gray-500 font-semibold rounded-lg">Cancel</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-500">Delete</button>
                </div>
            </div>
        </div>

        <!-- Voice Selection Modal -->
        <div id="voice-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-cyan-400">Select a Voice</h3>
                    <button id="voice-modal-close-btn" class="p-1 rounded-full hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div id="voice-options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Voice options will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Image Generation Modal -->
        <div id="image-gen-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-cyan-400">Generate an Image with Imagen</h3>
                    <button id="image-gen-close-btn" class="p-1 rounded-full hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="space-y-4">
                    <textarea id="image-gen-prompt" rows="3" placeholder="e.g., A serene painting of a sage meditating under a banyan tree in ancient India..." class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500"></textarea>
                    <div id="image-gen-loader" class="hidden items-center justify-center gap-2 text-gray-400">
                        <div class="w-5 h-5 border-2 border-gray-500 border-t-cyan-500 rounded-full animate-spin"></div>
                        <span>Generating your masterpiece...</span>
                    </div>
                    <button id="image-gen-submit-btn" class="w-full px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg shadow-lg hover:bg-cyan-500 transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed">
                        Generate
                    </button>
                </div>
            </div>
        </div>

        <!-- Task Scheduler Modal -->
        <div id="task-scheduler-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-cyan-400">Schedule a New Task</h3>
                    <button id="task-modal-close-btn" class="p-1 rounded-full hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="task-description" class="block text-sm font-medium text-gray-300 mb-1">Task Description (कार्यविवरणम्)</label>
                        <textarea id="task-description" rows="3" placeholder="e.g., Revise Sandhi rules..." class="task-input w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500"></textarea>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="task-date" class="block text-sm font-medium text-gray-300 mb-1">Date (दिनांकः)</label>
                            <input type="date" id="task-date" class="task-input w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        </div>
                        <div>
                            <label for="task-time" class="block text-sm font-medium text-gray-300 mb-1">Time (समयः)</label>
                            <input type="time" id="task-time" class="task-input w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        </div>
                    </div>
                    <div>
                        <label for="task-timezone" class="block text-sm font-medium text-gray-300 mb-1">Time Zone (समयक्षेत्रम्)</label>
                        <select id="task-timezone" class="task-input w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <!-- Timezones will be populated here -->
                        </select>
                    </div>
                    <div class="flex items-center pt-2">
                        <input id="task-alarm" type="checkbox" checked class="h-4 w-4 rounded border-gray-600 text-cyan-600 focus:ring-cyan-500 bg-gray-700">
                        <label for="task-alarm" class="ml-3 block text-sm font-medium text-gray-300">Enable Alarm (सूचना)</label>
                    </div>
                </div>
                <div class="mt-6 text-right">
                    <button id="save-task-btn" class="px-6 py-2 bg-cyan-600 text-white font-semibold rounded-lg shadow-lg hover:bg-cyan-500 transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed">
                        Save Task
                    </button>
                </div>
            </div>
        </div>

        <!-- Lesson Selection Modal -->
        <div id="lesson-selection-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-auto flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h3 id="lesson-selection-modal-title" class="text-xl font-bold text-cyan-400">Select a Lesson</h3>
                    <button id="lesson-selection-close-btn" class="p-1 rounded-full hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div id="lesson-selection-list" class="flex-grow overflow-y-auto custom-scrollbar space-y-2">
                    <!-- Lesson list will be injected here -->
                </div>
            </div>
        </div>

        <!-- Lesson Modal -->
        <div id="lesson-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl mx-auto flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h3 id="lesson-modal-title" class="text-xl font-bold text-cyan-400">Lesson</h3>
                    <button id="lesson-modal-close-btn" class="p-1 rounded-full hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div id="lesson-modal-content" class="text-gray-300 space-y-4 overflow-y-auto custom-scrollbar flex-grow">
                    <!-- Lesson content will be injected here -->
                </div>
                <div id="lesson-modal-footer" class="mt-6 flex-shrink-0 text-right">
                    <!-- Footer buttons will be injected here -->
                </div>
            </div>
        </div>

        <!-- Quiz Setup Modal -->
        <div id="quiz-setup-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="quiz-setup-modal-title" class="text-xl font-bold text-cyan-400">Setup Quiz</h3>
                    <button id="quiz-setup-close-btn" class="p-1 rounded-full hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Quiz Mode</label>
                        <div id="quiz-mode-options" class="grid grid-cols-2 gap-2">
                            <label class="quiz-setup-option text-center p-3 bg-gray-700 rounded-lg border-2 border-transparent cursor-pointer"><input type="radio" name="quizMode" value="Practice" class="hidden" checked>Practice<span class="block text-xs text-gray-400">Instant Feedback</span></label>
                            <label class="quiz-setup-option text-center p-3 bg-gray-700 rounded-lg border-2 border-transparent cursor-pointer"><input type="radio" name="quizMode" value="Test" class="hidden">Test<span class="block text-xs text-gray-400">Results at the end</span></label>
                        </div>
                    </div>
                    <div>
                        <label for="question-count-slider" class="block text-sm font-medium text-gray-300 mb-2">Number of Questions: <span id="question-count-value">10</span></label>
                        <input id="question-count-slider" type="range" min="5" max="50" value="10" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Difficulty Level</label>
                        <div id="difficulty-options" class="grid grid-cols-3 gap-2">
                            <label class="quiz-setup-option text-center p-2 bg-gray-700 rounded-lg border-2 border-transparent cursor-pointer"><input type="radio" name="difficulty" value="Easy" class="hidden" checked>Easy</label>
                            <label class="quiz-setup-option text-center p-2 bg-gray-700 rounded-lg border-2 border-transparent cursor-pointer"><input type="radio" name="difficulty" value="Medium" class="hidden">Medium</label>
                            <label class="quiz-setup-option text-center p-2 bg-gray-700 rounded-lg border-2 border-transparent cursor-pointer"><input type="radio" name="difficulty" value="Hard" class="hidden">Hard</label>
                        </div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Question Type</label>
                        <div id="question-type-options" class="grid grid-cols-2 sm:grid-cols-5 gap-2">
                            <label class="quiz-setup-option text-center p-2 bg-gray-700 rounded-lg border-2 border-transparent cursor-pointer"><input type="radio" name="questionType" value="mixed" class="hidden" checked>Mixed</label>
                            <label class="quiz-setup-option text-center p-2 bg-gray-700 rounded-lg border-2 border-transparent cursor-pointer"><input type="radio" name="questionType" value="single-correct" class="hidden">Single</label>
                            <label class="quiz-setup-option text-center p-2 bg-gray-700 rounded-lg border-2 border-transparent cursor-pointer"><input type="radio" name="questionType" value="multi-correct" class="hidden">Multi</label>
                            <label class="quiz-setup-option text-center p-2 bg-gray-700 rounded-lg border-2 border-transparent cursor-pointer"><input type="radio" name="questionType" value="fill-in-the-blank" class="hidden">Fill-in</label>
                             <label class="quiz-setup-option text-center p-2 bg-gray-700 rounded-lg border-2 border-transparent cursor-pointer"><input type="radio" name="questionType" value="matching" class="hidden">Match</label>
                        </div>
                    </div>
                </div>
                <div class="mt-8 text-right">
                    <button id="start-quiz-from-setup-btn" class="px-6 py-2 bg-cyan-600 text-white font-semibold rounded-lg hover:bg-cyan-500">Start Quiz</button>
                </div>
            </div>
        </div>

        <!-- Quiz Modal -->
        <div id="quiz-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl mx-auto flex flex-col max-h-[90vh]">
                 <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h3 id="quiz-modal-title" class="text-xl font-bold text-cyan-400">Quiz</h3>
                    <div id="quiz-progress-indicator" class="text-sm text-gray-400"></div>
                </div>
                <div id="quiz-modal-content" class="flex-grow overflow-y-auto custom-scrollbar">
                    <!-- Quiz content will be injected here -->
                </div>
                 <div id="quiz-modal-footer" class="mt-6 flex-shrink-0 text-right space-x-2">
                    <button id="quiz-submit-answer-btn" class="hidden px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500">Submit Answer</button>
                    <button id="quiz-next-btn" class="hidden px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg hover:bg-cyan-500">Next Question</button>
                    <button id="quiz-review-btn" class="hidden px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-500">Review Answers</button>
                    <button id="quiz-close-btn" class="hidden px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Achievements Modal -->
        <div id="achievements-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl mx-auto flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h3 class="text-xl font-bold text-cyan-400">My Achievements</h3>
                    <button id="achievements-close-btn" class="p-1 rounded-full hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div id="achievements-list" class="flex-grow overflow-y-auto custom-scrollbar grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Achievements will be injected here -->
                </div>
            </div>
        </div>
    </div>
    <audio id="audio-player" class="hidden"></audio>
    <audio id="alarm-sound" loop class="hidden">
        <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    </audio>
    <script>
        let selectedVoice = 'Achird'; // Default voice

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const loginScreen = document.getElementById('login-screen');
            const dashboardScreen = document.getElementById('dashboard-screen');
            const chatScreen = document.getElementById('chat-screen');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const menuBtn = document.getElementById('menu-btn');
            const historySidebar = document.getElementById('history-sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const newChatBtn = document.getElementById('new-chat-btn');
            const searchChatsInput = document.getElementById('search-chats-input');
            const chatHistoryList = document.getElementById('chat-history-list');
            const deleteAllChatsBtn = document.getElementById('delete-all-chats-btn');
            const messagesContainer = document.getElementById('messages-container');
            const noActiveChatScreen = document.getElementById('no-active-chat-screen');
            const startNewChatBtn = document.getElementById('start-new-chat-btn');
            const inputArea = document.getElementById('input-area');
            const inputField = document.getElementById('input-field');
            const sendBtn = document.getElementById('send-btn');
            const stopBtn = document.getElementById('stop-btn');
            const micBtn = document.getElementById('mic-btn');
            const fileBtn = document.getElementById('file-btn');
            const fileInput = document.getElementById('file-input');
            const filePreviewContainer = document.getElementById('file-preview-container');
            const filePreviewContent = document.getElementById('file-preview-content');
            const removeFileBtn = document.getElementById('remove-file-btn');
            const regenerateBtn = document.getElementById('regenerate-btn');
            const clearInputBtn = document.getElementById('clear-input-btn');
            const audioPlayer = document.getElementById('audio-player');
            const stopAudioContainer = document.getElementById('stop-audio-container');
            const viewModeIndicator = document.getElementById('view-mode-indicator');
            const confirmationModal = document.getElementById('confirmation-modal');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const voiceSelectBtn = document.getElementById('voice-select-btn');
            const voiceModal = document.getElementById('voice-modal');
            const voiceModalCloseBtn = document.getElementById('voice-modal-close-btn');
            const voiceOptionsContainer = document.getElementById('voice-options-container');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeIconSun = document.getElementById('theme-icon-sun');
            const themeIconMoon = document.getElementById('theme-icon-moon');
            const imageGenBtn = document.getElementById('image-gen-btn');
            const imageGenModal = document.getElementById('image-gen-modal');
            const imageGenCloseBtn = document.getElementById('image-gen-close-btn');
            const imageGenPrompt = document.getElementById('image-gen-prompt');
            const imageGenSubmitBtn = document.getElementById('image-gen-submit-btn');
            const imageGenLoader = document.getElementById('image-gen-loader');
            const scheduleTaskBtn = document.getElementById('schedule-task-btn');
            const guidedLearningBtn = document.getElementById('guided-learning-btn');
            const deepThinkBtn = document.getElementById('deep-think-btn');
            const taskSchedulerModal = document.getElementById('task-scheduler-modal');
            const taskModalCloseBtn = document.getElementById('task-modal-close-btn');
            const saveTaskBtn = document.getElementById('save-task-btn');
            const taskDescription = document.getElementById('task-description');
            const taskDate = document.getElementById('task-date');
            const taskTime = document.getElementById('task-time');
            const taskTimezone = document.getElementById('task-timezone');
            const switchToChatBtn = document.getElementById('switch-to-chat-btn');
            const dashboardMenuBtn = document.getElementById('dashboard-menu-btn');
            const dashboardMenuDropdown = document.getElementById('dashboard-menu-dropdown');
            const dashboardTitle = document.getElementById('dashboard-title');
            const modulesGrid = document.getElementById('modules-grid');
            const lessonSelectionModal = document.getElementById('lesson-selection-modal');
            const lessonSelectionTitle = document.getElementById('lesson-selection-modal-title');
            const lessonSelectionList = document.getElementById('lesson-selection-list');
            const lessonSelectionCloseBtn = document.getElementById('lesson-selection-close-btn');
            const lessonModal = document.getElementById('lesson-modal');
            const lessonModalTitle = document.getElementById('lesson-modal-title');
            const lessonModalContent = document.getElementById('lesson-modal-content');
            const lessonModalFooter = document.getElementById('lesson-modal-footer');
            const lessonModalCloseBtn = document.getElementById('lesson-modal-close-btn');
            const quizSetupModal = document.getElementById('quiz-setup-modal');
            const quizSetupCloseBtn = document.getElementById('quiz-setup-close-btn');
            const quizSetupTitle = document.getElementById('quiz-setup-modal-title');
            const questionCountSlider = document.getElementById('question-count-slider');
            const questionCountValue = document.getElementById('question-count-value');
            const startQuizFromSetupBtn = document.getElementById('start-quiz-from-setup-btn');
            const quizModal = document.getElementById('quiz-modal');
            const quizModalTitle = document.getElementById('quiz-modal-title');
            const quizModalContent = document.getElementById('quiz-modal-content');
            const quizModalFooter = document.getElementById('quiz-modal-footer');
            const quizProgressIndicator = document.getElementById('quiz-progress-indicator');
            const quizSubmitAnswerBtn = document.getElementById('quiz-submit-answer-btn');
            const quizNextBtn = document.getElementById('quiz-next-btn');
            const quizReviewBtn = document.getElementById('quiz-review-btn');
            const quizCloseBtn = document.getElementById('quiz-close-btn');
            const achievementsBtn = document.getElementById('achievements-btn');
            const achievementsModal = document.getElementById('achievements-modal');
            const achievementsList = document.getElementById('achievements-list');
            const achievementsCloseBtn = document.getElementById('achievements-close-btn');
            const toolsMenuBtn = document.getElementById('tools-menu-btn');
            const toolsMenuDropdown = document.getElementById('tools-menu-dropdown');
            const exportChatBtn = document.getElementById('export-chat-btn');
            const alarmSound = document.getElementById('alarm-sound');

            // --- State Management ---
            let isLoading = false;
            let playingMessageId = null;
            let editingMessageId = null;
            let messages = [];
            let allChatsCache = [];
            let bookmarkedMessageIds = new Set();
            let isRecognizing = false;
            let currentFile = null;
            let abortController;
            let activeChatId = null;
            let currentModalAction = null;
            let currentTheme = 'dark';
            let learningProgress = {};
            let currentQuiz = {};
            let activeCourseId = 'course1';
            let alarmIntervalId = null;
            
            // --- Firebase State ---
            let db, auth, userId, storage;
            let unsubscribeUserDoc = () => {};
            let unsubscribeChatDoc = () => {};
            let unsubscribeChatsCol = () => {};
            let unsubscribeProgress = () => {};

            // --- Speech Recognition Setup ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                recognition.onstart = () => { isRecognizing = true; micBtn.classList.add('text-red-500', 'mic-listening'); };
                recognition.onresult = (event) => { inputField.value = event.results[0][0].transcript; updateInputButtons(); };
                recognition.onend = () => { isRecognizing = false; micBtn.classList.remove('text-red-500', 'mic-listening'); };
                recognition.onerror = (event) => { console.error('Speech recognition error:', event.error); isRecognizing = false; micBtn.classList.remove('text-red-500', 'mic-listening'); };
            } else {
                console.log('Speech Recognition not supported.');
                micBtn.style.display = 'none';
            }
            
            const initialMessage = { id: Date.now(), text: "नमस्ते! अहं संस्कृतमित्रम्।", sender: 'bot' };
            
            // --- Subhashita Data ---
            const subhashitas = [
                { verse: "अयं निजः परो वेति गणना लघुचेतसाम् । उदारचरितानां तु वसुधैव कुटुम्बकम् ॥", translation: "This is mine, that is his, say the small-minded. For the magnanimous, the entire world is a family.", explanation: "This verse from the Maha Upanishad teaches about universal brotherhood and the importance of having a broad perspective." },
                { verse: "उद्यमेन हि सिध्यन्ति कार्याणि न मनोरथैः । न हि सुप्तस्य सिंहस्य प्रविशन्ति मुखे मृगाः ॥", translation: "Goals are achieved by effort, not by just wishing for them. Deer do not just walk into a sleeping lion's mouth.", explanation: "This verse from the Hitopadesha emphasizes the necessity of hard work and action to achieve success." },
                { verse: "काव्यशास्त्रविनोदेन कालो गच्छति धीमताम् । व्यसनेन तु मूर्खाणां निद्रया कलहेन वा ॥", translation: "The wise spend their time in the delight of literature and sciences. The foolish spend their time in addiction, sleep, or quarrel.", explanation: "This verse highlights the difference in how wise people and foolish people utilize their time." },
                { verse: "विद्या ददाति विनयं विनयाद् याति पात्रताम् । पात्रत्वाद्धनमाप्नोति धनाद्धर्मं ततः सुखम् ॥", translation: "Knowledge gives humility, from humility one attains character. From character one acquires wealth, from wealth good deeds (dharma), and then happiness.", explanation: "This verse explains the path to true happiness, starting with the foundation of knowledge." }
            ];

            const getRandomSubhashita = () => {
                const randomIndex = Math.floor(Math.random() * subhashitas.length);
                return subhashitas[randomIndex];
            };

            // --- Learning Modules Structure ---
            const modules = {
                'sanskrit-basics': {
                    name: "Sanskrit Basics",
                    lessons: [
                        { id: 'alphabets', name: 'Sanskrit Alphabets (वर्णमाला)' },
                        { id: 'matras', name: 'Vowel Signs (मात्राः)' },
                        { id: 'numbers', name: 'Numerals (संख्याः)' },
                        { id: 'symbols', name: 'Symbols & Avagraha (चिह्नानि च अवग्रहः)' },
                        { id: 'sentence-structure', name: 'Basic Sentence Structure' },
                        { id: 'simple-pronouns', name: 'Simple Pronouns (सर्वनाम)' },
                        { id: 'common-indeclinables', name: 'Common Indeclinables (अव्ययानि)' },
                        { id: 'simple-verbs', name: 'Simple Verbs (क्रियापदानि)' },
                        { id: 'question-words', name: 'Question Words (प्रश्नवाचकशब्दाः)' },
                        { id: 'basic-conjunctions', name: 'Basic Conjunctions (समुच्चयबोधकाः)' }
                    ]
                },
                'sabda-rupa': {
                    name: "Śabda Rūpa (Noun Declension)",
                    lessons: [
                        { id: 'sabda-intro', name: 'Introduction to Śabda Rūpa' },
                        { id: 'akaranta-pumlinga', name: 'Akārānta Puṃliṅga (-a, masc.)' },
                        { id: 'akaranta-strilinga', name: 'Ākārānta Strīliṅga (-ā, fem.)' },
                        { id: 'ikaranta-pumlinga', name: 'Ikārānta Puṃliṅga (-i, masc.)' },
                        { id: 'ikaranta-strilinga', name: 'Īkārānta Strīliṅga (-ī, fem.)' },
                        { id: 'ukaranta-napumsaka', name: 'Ukārānta Napuṃsakaliṅga (-u, neut.)' },
                        { id: 'rkaranata-pumlinga', name: 'Ṛkārānta Puṃliṅga (-ṛ, masc.)' },
                        { id: 'halanta-sabdas', name: 'Halanta Śabdas (Consonant-ending)' }
                    ]
                },
                'dhatu-rupa': {
                    name: "Dhātu Rūpa (Verb Conjugation)",
                    lessons: [
                        { id: 'dhatu-intro', name: 'Introduction to Dhātu Rūpa' },
                        { id: 'parasmaipada-atmanepada', name: 'Parasmaipada & Ātmanepada' },
                        { id: 'ganas', name: 'The 10 Gaṇas (Classes of Verbs)' },
                        { id: 'bhu-dhatu', name: 'Conjugating Bhū Dhātu (1P)' },
                        { id: 'gam-dhatu', name: 'Conjugating Gam Dhātu (1P)' },
                        { id: 'sev-dhatu', name: 'Conjugating Sev Dhātu (1A)' }
                    ]
                },
                'karaka-vibhakti': {
                    name: "Kāraka & Vibhakti (Case System)",
                    lessons: [
                        { id: 'karaka-intro', name: 'Introduction to Kāraka & Vibhakti' },
                        { id: 'prathama', name: 'Prathamā Vibhakti (Nominative)' },
                        { id: 'dvitiya', name: 'Dvitīyā Vibhakti (Accusative)' },
                        { id: 'tritiya', name: 'Tṛtīyā Vibhakti (Instrumental)' },
                        { id: 'caturthi', name: 'Caturthī Vibhakti (Dative)' },
                        { id: 'pancami', name: 'Pañcamī Vibhakti (Ablative)' },
                        { id: 'sasthi', name: 'Ṣaṣṭhī Vibhakti (Genitive)' },
                        { id: 'saptami', name: 'Saptamī Vibhakti (Locative)' },
                        { id: 'upapada-vibhakti', name: 'Upapada Vibhakti' }
                    ]
                },
                sandhi: { 
                    name: "Sandhi (Euphonic Combination)",
                    lessons: [ 
                        { id: 'sandhi-intro', name: 'Introduction to Sandhi' }, 
                        { id: 'savarna-dirgha', name: 'Savarna Dīrgha Sandhi' },
                        { id: 'guna', name: 'Guṇa Sandhi' },
                        { id: 'vriddhi', name: 'Vṛddhi Sandhi' },
                        { id: 'yan', name: 'Yaṇ Sandhi (Iko Yaṇaci)' },
                        { id: 'ayadi', name: 'Ayādi Sandhi' },
                        { id: 'purvarupa', name: 'Pūrvarūpa Sandhi' },
                        { id: 'visarga-utva', name: 'Visarga Sandhi - Utva' },
                        { id: 'visarga-rutva', name: 'Visarga Sandhi - Rutva' },
                        { id: 'vyanjana-stutva', name: 'Vyañjana Sandhi - Ścutva & ṣṭutva' },
                        { id: 'vyanjana-jastva', name: 'Vyañjana Sandhi - Jaśtva' }
                    ] 
                },
                samasa: { 
                    name: "Samāsa (Compound Words)",
                    lessons: [
                        { id: 'samasa-intro', name: 'Introduction to Samāsa' },
                        { id: 'avyayibhava', name: 'Avyayībhāva Samāsa' },
                        { id: 'tatpurusa', name: 'Tatpuruṣa Samāsa' },
                        { id: 'karmadharaya', name: 'Karmadhāraya Samāsa' },
                        { id: 'dvigu', name: 'Dvigu Samāsa' },
                        { id: 'bahuvrihi', name: 'Bahuvrīhi Samāsa' },
                        { id: 'dvandva', name: 'Dvandva Samāsa' }
                    ] 
                },
                lakara: { 
                    name: "Lakāra (Tense and Mood)",
                    lessons: [
                        { id: 'lakara-intro', name: 'Introduction to the 10 Lakāras' },
                        { id: 'lat', name: 'Laṭ Lakāra (Present)' },
                        { id: 'lrt', name: 'Lṛṭ Lakāra (Future)' },
                        { id: 'lan', name: 'Laṅ Lakāra (Imperfect Past)' },
                        { id: 'lot', name: 'Loṭ Lakāra (Imperative)' },
                        { id: 'vidhi-lin', name: 'Vidhi Liṅ (Potential)' },
                        { id: 'lit', name: 'Liṭ Lakāra (Perfect)' },
                        { id: 'lun', name: 'Luṅ Lakāra (Aorist)' }
                    ] 
                },
                 prayoga: {
                    name: "Prayoga (Voice)",
                    lessons: [
                        { id: 'prayoga-intro', name: 'Introduction to Prayoga' },
                        { id: 'kartari-prayoga', name: 'Kartari Prayoga (Active Voice)' },
                        { id: 'sakarmaka-kartari', name: 'Sakarmaka Kartari (Transitive Active)' },
                        { id: 'akarmaka-kartari', name: 'Akarmaka Kartari (Intransitive Active)' },
                        { id: 'karmani-prayoga', name: 'Karmani Prayoga (Passive Voice)' },
                        { id: 'karmani-rules', name: 'Rules for Karmani Prayoga' },
                        { id: 'kartari-to-karmani', name: 'Transforming Kartari to Karmani' },
                        { id: 'bhave-prayoga', name: 'Bhave Prayoga (Impersonal Voice)' },
                        { id: 'bhave-rules', name: 'Rules for Bhave Prayoga' },
                        { id: 'kartari-to-bhave', name: 'Transforming Kartari to Bhave' },
                        { id: 'karma-kartari-prayoga', name: 'Karma-kartari Prayoga (Pseudo-Passive)' }
                    ]
                },
                'ashtadhyayi-core': {
                    name: "Aṣṭādhyāyī (Core Concepts)",
                    lessons: [
                        { id: 'panini-intro', name: 'Introduction to Pāṇini & Aṣṭādhyāyī' },
                        { id: 'structure', name: 'Structure: Adhyāya, Pāda, Sūtra' },
                        { id: 'siva-sutras', name: 'The Śiva Sūtras' },
                        { id: 'pratyahara', name: 'Pratyāhāras' },
                        { id: 'sutra-types', name: 'Types of Sūtras (Saṃjñā, Paribhāṣā, etc.)' },
                        { id: 'anuvrtti', name: 'Anuvṛtti & Adhikāra' }
                    ]
                },
                'ashtadhyayi-technical-terms': {
                    name: "Aṣṭādhyāyī Technical Terms",
                    lessons: [
                        { id: 'samjna-intro', name: 'Introduction to Saṃjñā' },
                        { id: 'it-samjna', name: 'It-saṃjñā (Anubandha)' },
                        { id: 'lopa', name: 'Lopa, Ślu, Luk (Elision)' },
                        { id: 'guna-vrddhi', name: 'Guṇa & Vṛddhi' },
                        { id: 'samprasarana', name: 'Saṃprasāraṇa' },
                        { id: 'pratipadika', name: 'Prātipadika (Nominal Stem)' },
                        { id: 'pada', name: 'Pada (Finished Word)' },
                        { id: 'dhatu', name: 'Dhātu (Verbal Root)' },
                        { id: 'anga', name: 'Aṅga (Stem)' },
                        { id: 'upasarga-gati', name: 'Upasarga & Gati' },
                        { id: 'nipata', name: 'Nipāta (Indeclinable)' },
                        { id: 'vibhakti', name: 'Vibhakti (Inflection)' },
                        { id: 'sarvanamasthana', name: 'Sarvanāmasthāna' },
                        { id: 'abhyasa', name: 'Abhyāsa (Reduplication)' },
                        { id: 'samhita', name: 'Saṃhitā' }
                    ]
                },
                'laghu-siddhanta-kaumudi': {
                    name: "Laghu Siddhānta Kaumudī",
                    lessons: [
                        { id: 'lsk-mangalacarana', name: 'Maṅgalācaraṇa & Introduction' },
                        { id: 'lsk-samjna', name: 'Saṃjñā Prakaraṇa' },
                        { id: 'lsk-paribhasa', name: 'Paribhāṣā Prakaraṇa' },
                        { id: 'lsk-ac-sandhi', name: 'Ac Sandhi Prakaraṇa' },
                        { id: 'lsk-hal-sandhi', name: 'Hal Sandhi Prakaraṇa' },
                        { id: 'lsk-visarga-sandhi', name: 'Visarga Sandhi Prakaraṇa' },
                        { id: 'lsk-ajanta-pumlinga', name: 'Ajanta Puṃliṅga Prakaraṇa' },
                        { id: 'lsk-ajanta-strilinga', name: 'Ajanta Strīliṅga Prakaraṇa' },
                        { id: 'lsk-ajanta-napumsakalinga', name: 'Ajanta Napuṃsakaliṅga Prakaraṇa' },
                        { id: 'lsk-halanta-pumlinga', name: 'Halanta Puṃliṅga Prakaraṇa' },
                        { id: 'lsk-halanta-strilinga', name: 'Halanta Strīliṅga Prakaraṇa' },
                        { id: 'lsk-halanta-napumsakalinga', name: 'Halanta Napuṃsakaliṅga Prakaraṇa' },
                        { id: 'lsk-avyaya', name: 'Avyaya Prakaraṇa' },
                        { id: 'lsk-stripratyaya', name: 'Strīpratyaya Prakaraṇa' },
                        { id: 'lsk-karaka', name: 'Kāraka Prakaraṇa' },
                        { id: 'lsk-samasa', name: 'Samāsa Prakaraṇa' },
                        { id: 'lsk-taddhita', name: 'Taddhita Prakaraṇa' },
                        { id: 'lsk-tinanta-bhu-adi', name: 'Tiṅanta - Bhvādi Gaṇa' },
                        { id: 'lsk-tinanta-ad-adi', name: 'Tiṅanta - Adādi Gaṇa' },
                        { id: 'lsk-krdanta', name: 'Kṛdanta Prakaraṇa' }
                    ]
                },
                'siddhanta-kaumudi': {
                    name: "Siddhānta Kaumudī (Advanced)",
                    lessons: [
                        { id: 'sk-samjna-paribhasa', name: 'Saṃjñā & Paribhāṣā Prakaraṇa' },
                        { id: 'sk-panc-sandhi', name: 'Pañcasandhi Prakaraṇa' },
                        { id: 'sk-subanta', name: 'Subanta Prakaraṇa (Declensions)' },
                        { id: 'sk-avyaya', name: 'Avyaya Prakaraṇa' },
                        { id: 'sk-stripratyaya', name: 'Strīpratyaya Prakaraṇa' },
                        { id: 'sk-karaka', name: 'Kāraka Prakaraṇa' },
                        { id: 'sk-samasa', name: 'Samāsa Prakaraṇa' },
                        { id: 'sk-taddhita', name: 'Taddhita Prakaraṇa' },
                        { id: 'sk-dvirukta', name: 'Dvirukta Prakaraṇa' },
                        { id: 'sk-tinanta-bhu-adi', name: 'Tiṅanta - Bhvādi Gaṇa' },
                        { id: 'sk-tinanta-ad-adi', name: 'Tiṅanta - Adādi Gaṇa' },
                        { id: 'sk-tinanta-juhoty-adi', name: 'Tiṅanta - Juhotyādi Gaṇa' },
                        { id: 'sk-tinanta-div-adi', name: 'Tiṅanta - Divādi Gaṇa' },
                        { id: 'sk-tinanta-sv-adi', name: 'Tiṅanta - Svādi Gaṇa' },
                        { id: 'sk-tinanta-tud-adi', name: 'Tiṅanta - Tudādi Gaṇa' },
                        { id: 'sk-tinanta-rudh-adi', name: 'Tiṅanta - Rudhādi Gaṇa' },
                        { id: 'sk-tinanta-tan-adi', name: 'Tiṅanta - Tanādi Gaṇa' },
                        { id: 'sk-tinanta-kry-adi', name: 'Tiṅanta - Kryādi Gaṇa' },
                        { id: 'sk-tinanta-cur-adi', name: 'Tiṅanta - Curādi Gaṇa' },
                        { id: 'sk-krdanta', name: 'Kṛdanta Prakaraṇa' },
                        { id: 'sk-vaidiki', name: 'Vaidikī Prakriyā' },
                        { id: 'sk-svara', name: 'Svara Prakriyā (Accentuation)' }
                    ]
                },
                'katyayana-varttika': {
                    name: "Kātyāyana's Vārttikas",
                    lessons: [
                        { id: 'kv-intro', name: 'Introduction to Vārttikas' },
                        { id: 'kv-purpose', name: 'Purpose & Classification of Vārttikas' },
                        { id: 'kv-methodology', name: 'Methodology and Structure' },
                        { id: 'kv-samjna', name: 'Vārttikas on Saṃjñā' },
                        { id: 'kv-ac-sandhi', name: 'Vārttikas on Ac Sandhi' },
                        { id: 'kv-hal-sandhi', name: 'Vārttikas on Hal Sandhi' },
                        { id: 'kv-karaka', name: 'Vārttikas on Kāraka' },
                        { id: 'kv-samasa', name: 'Vārttikas on Samāsa' },
                        { id: 'kv-stripratyaya', name: 'Vārttikas on Strīpratyaya' },
                        { id: 'kv-taddhita', name: 'Vārttikas on Taddhita' },
                        { id: 'kv-tinanta', name: 'Vārttikas on Tiṅanta' },
                        { id: 'kv-panini-patanjali', name: 'Pāṇini, Kātyāyana & Patañjali' }
                    ]
                },
                'patanjali-maha-bhashya': {
                    name: "Patañjali's Mahābhāṣya",
                    lessons: [
                        { id: 'pm-intro', name: 'Introduction to the Mahābhāṣya' },
                        { id: 'pm-purpose', name: 'Purpose and Scope (Prayojana)' },
                        { id: 'pm-structure', name: 'Structure: Āhnikas' },
                        { id: 'pm-paspasahnika', name: 'Paspasāhnika (Introductory Chapter)' },
                        { id: 'pm-relationship', name: 'Relationship with Aṣṭādhyāyī & Vārttikas' },
                        { id: 'pm-philosophy', name: 'Key Philosophical Concepts' },
                        { id: 'pm-sabda-nityatva', name: 'Śabda Nityatva (Eternality of Words)' },
                        { id: 'pm-sphota', name: 'Sphota Theory' },
                        { id: 'pm-sutra-1-1-1', name: 'Analysis of Sūtra 1.1.1 (Vṛddhirādaic)' },
                        { id: 'pm-sutra-1-3-1', name: 'Analysis of Sūtra 1.3.1 (Bhūvādayo dhātavaḥ)' },
                        { id: 'pm-commentaries', name: 'Commentaries on the Mahābhāṣya' }
                    ]
                },
                'conclusion-further-studies': {
                    name: "Conclusion & Further Studies I",
                    lessons: [
                        { id: 'cfs-review', name: 'Course I Review & Consolidation' },
                        { id: 'cfs-literature', name: 'Introduction to Sanskrit Literature (साहित्यम्)' },
                        { id: 'cfs-reading', name: 'Reading Primary Texts (मूलग्रन्थपठनम्)' },
                        { id: 'cfs-shastras', name: 'Exploring Different Śāstras' },
                        { id: 'cfs-resources', name: 'Resources for Advanced Study' },
                        { id: 'cfs-next-steps', name: 'Next Steps: SAN Course II' }
                    ]
                },
                'chandas': {
                    name: "Chandas (Prosody)",
                    lessons: [
                        { id: 'chandas-intro', name: 'Introduction to Chandas' },
                        { id: 'laghu-guru', name: 'Laghu & Guru Identification' },
                        { id: 'gana-system', name: 'The Gaṇa System (yamātārājabhānasalagaṃ)' },
                        { id: 'anushtubh', name: 'Anuṣṭubh Meter' },
                        { id: 'tristubh-jagati', name: 'Triṣṭubh & Jagatī Meters' },
                        { id: 'upajati', name: 'Upajāti (Indravajrā & Upendravajrā)' },
                        { id: 'vasantatilaka', name: 'Vasantatilakā Meter' },
                        { id: 'malini', name: 'Mālinī Meter' },
                        { id: 'sardulavikridita', name: 'Śārdūlavikrīḍita Meter' },
                        { id: 'mandakranta', name: 'Mandākrāntā Meter' },
                        { id: 'sikhariṇi', name: 'Śikhariṇī Meter' },
                        { id: 'sragdhara', name: 'Sragdharā Meter' },
                        { id: 'arya', name: 'Āryā (Mātrā-based Meter)' }
                    ]
                },
                'alankara': {
                    name: "Alaṅkāra (Figures of Speech)",
                    lessons: [
                        { id: 'alankara-intro', name: 'Introduction to Alaṅkāra' },
                        { id: 'sabdalankara-intro', name: 'Śabdālaṅkāra (Sound-based)' },
                        { id: 'anuprasa', name: 'Anuprāsa (Alliteration)' },
                        { id: 'yamaka', name: 'Yamaka (Repetition/Rhyme)' },
                        { id: 'slesa', name: 'Śleṣa (Pun/Paronomasia)' },
                        { id: 'arthalankara-intro', name: 'Arthālaṅkāra (Meaning-based)' },
                        { id: 'upama', name: 'Upamā (Simile)' },
                        { id: 'rupaka', name: 'Rūpaka (Metaphor)' },
                        { id: 'utpreksa', name: 'Utprekṣā (Poetic Fancy)' },
                        { id: 'atisayokti', name: 'Atiśayokti (Hyperbole)' },
                        { id: 'drstanta', name: 'Dṛṣṭānta (Exemplification)' },
                        { id: 'arthantaranyasa', name: 'Arthāntaranyāsa (Corroboration)' },
                        { id: 'vyatireka', name: 'Vyatireka (Contrast)' },
                        { id: 'vibhavana', name: 'Vibhāvanā (Effect without a Cause)' },
                        { id: 'visheshokti', name: 'Viśeṣokti (Cause without an Effect)' }
                    ]
                },
                'vedic-sanskrit': {
                    name: "Vedic Sanskrit",
                    lessons: [
                        { id: 'vedic-intro', name: 'Vedic vs. Classical Sanskrit' },
                        { id: 'vedic-phonology', name: 'Vedic Phonology (e.g., ळ)' },
                        { id: 'pitch-accent', name: 'The Pitch Accent (Udātta, Anudātta, Svarita)' },
                        { id: 'vedic-sandhi', name: 'Peculiarities of Vedic Sandhi' },
                        { id: 'vedic-verbs-subjunctive', name: 'The Subjunctive Mood (Leṭ)' },
                        { id: 'vedic-verbs-injunctive', name: 'The Injunctive Mood' },
                        { id: 'vedic-infinitives', name: 'Vedic Infinitives' },
                        { id: 'vedic-declension', name: 'Vedic Noun Declension Differences' },
                        { id: 'vedic-vocabulary', name: 'Vedic Vocabulary & Archaic Words' },
                        { id: 'reading-rigveda', name: 'Reading a simple Rigvedic Hymn' }
                    ]
                },
                'kavya-shastra': {
                    name: "Kāvya Śāstra (Poetics)",
                    lessons: [
                        { id: 'kavya-intro', name: 'Introduction to Kāvya Śāstra' },
                        { id: 'rasa-sutra', name: 'Rasa Sūtra of Bharata Muni' },
                        { id: 'bhava-vibhava', name: 'Bhāva, Vibhāva, Anubhāva' },
                        { id: 'dhvani-theory', name: 'Dhvani Theory (Ānandavardhana)' },
                        { id: 'vakrokti', name: 'Vakrokti (Kuntaka)' },
                        { id: 'kavya-prakasha', name: 'Introduction to Kāvyaprakāśa (Mammaṭa)' }
                    ]
                },
                'nyaya-vaisheshika': {
                    name: "Nyāya-Vaiśeṣika",
                    lessons: [
                        { id: 'nyaya-intro', name: 'Introduction to Nyāya Philosophy' },
                        { id: 'pramanas', name: 'The Pramāṇas (Means of Knowledge)' },
                        { id: 'padarthas', name: 'The 16 Padārthas of Gautama' },
                        { id: 'vaisheshika-intro', name: 'Introduction to Vaiśeṣika Philosophy' },
                        { id: 'dravya-guna-karma', name: 'Dravya, Guṇa, Karma' },
                        { id: 'paramanu-vada', name: 'Paramāṇu-vāda (Atomism)' }
                    ]
                },
                'mimamsa': {
                    name: "Mīmāṃsā",
                    lessons: [
                        { id: 'mimamsa-intro', name: 'Introduction to Mīmāṃsā School' },
                        { id: 'sabda-pramana', name: 'Śabda as Primary Pramāṇa' },
                        { id: 'dharma-definition', name: 'The Definition of Dharma' },
                        { id: 'vidhi-arthavada', name: 'Vidhi, Niṣedha, Arthavāda' },
                        { id: 'bhavana', name: 'The concept of Bhāvanā' }
                    ]
                },
                'reading-practice-1': {
                    name: "Reading Practice I",
                    lessons: [
                        { id: 'rp1-panchatantra', name: 'Selections from Pañcatantra' },
                        { id: 'rp1-subhashita', name: 'Subhāṣita Reading' },
                        { id: 'rp1-simple-stories', name: 'Simple Conversational Stories' }
                    ]
                },
                'reading-practice-2': {
                    name: "Reading Practice II",
                    lessons: [
                        { id: 'rp2-hitopadesha', name: 'Selections from Hitopadeśa' },
                        { id: 'rp2-raghuvamsha', name: 'Selections from Raghuvaṃśa' },
                        { id: 'rp2-kiratarjuniya', name: 'Selections from Kirātārjunīya' }
                    ]
                },
                'vedanta': {
                    name: "Vedānta Philosophy",
                    lessons: [
                        { id: 'vedanta-intro', name: 'Introduction to Vedānta' },
                        { id: 'advaita-vedanta', name: 'Advaita Vedānta (Śaṅkara)' },
                        { id: 'brahman-atman', name: 'Brahman, Ātman, and Māyā' },
                        { id: 'vishishtadvaita', name: 'Viśiṣṭādvaita (Rāmānuja)' },
                        { id: 'dvaita-vedanta', name: 'Dvaita Vedānta (Madhva)' },
                        { id: 'brahma-sutras', name: 'Introduction to the Brahma Sūtras' }
                    ]
                },
                'sankhya-yoga': {
                    name: "Sāṅkhya & Yoga",
                    lessons: [
                        { id: 'sankhya-intro', name: 'Introduction to Sāṅkhya' },
                        { id: 'purusha-prakriti', name: 'Puruṣa and Prakṛti' },
                        { id: 'gunas', name: 'The Three Guṇas' },
                        { id: 'yoga-intro', name: 'Introduction to Yoga Philosophy' },
                        { id: 'yoga-sutras', name: 'Patañjali\'s Yoga Sūtras' },
                        { id: 'ashtanga-yoga', name: 'The Eight Limbs of Yoga (Aṣṭāṅga)' }
                    ]
                },
                'advanced-vyakarana': {
                    name: "Advanced Vyākaraṇa",
                    lessons: [
                        { id: 'vyakarana-philosophy', name: 'Philosophy of Grammar (Śabda-Brahman)' },
                        { id: 'paribhashendushekhara', name: 'Introduction to Paribhāṣenduśekhara' },
                        { id: 'vaiyakaranabhusanasara', name: 'Introduction to Vaiyākaraṇabhūṣaṇasāra' },
                        { id: 'sphota-vada-detail', name: 'Sphota-vāda in Detail (Bhartṛhari)' }
                    ]
                },
                'epigraphy-manuscriptology': {
                    name: "Epigraphy & Manuscriptology",
                    lessons: [
                        { id: 'epigraphy-intro', name: 'Introduction to Indian Epigraphy' },
                        { id: 'brahmi-script', name: 'Reading Brahmi Script' },
                        { id: 'gupta-script', name: 'Reading Gupta Script' },
                        { id: 'manuscriptology-intro', name: 'Introduction to Manuscriptology' },
                        { id: 'reading-manuscripts', name: 'Challenges in Reading Manuscripts' }
                    ]
                },
                'reading-practice-3': {
                    name: "Reading Practice III",
                    lessons: [
                        { id: 'rp3-nyayasutra', name: 'Selections from Nyāya Sūtras with Bhāṣya' },
                        { id: 'rp3-mahabhashya', name: 'Selections from Mahābhāṣya' },
                        { id: 'rp3-shakuntala', name: 'Reading Abhijñānaśākuntalam' }
                    ]
                },
                'conclusion-course-2': {
                    name: "Conclusion & Further Studies II",
                    lessons: [
                        { id: 'cfs2-review', name: 'Course II Review & Consolidation' },
                        { id: 'cfs2-kavya-analysis', name: 'Analyzing Kāvya with Poetics' },
                        { id: 'cfs2-darshana-intro', name: 'Introduction to Darśana (Philosophy)' },
                        { id: 'cfs2-resources', name: 'Intermediate Study Resources' },
                        { id: 'cfs2-next-steps', name: 'Next Steps: SAN Course III' }
                    ]
                },
                'conclusion-course-3': {
                    name: "Conclusion & Further Studies III",
                    lessons: [
                        { id: 'cfs3-review', name: 'Course III Review & Synthesis' },
                        { id: 'cfs3-shastra-debate', name: 'Understanding Śāstric Debates' },
                        { id: 'cfs3-research', name: 'Pathways to Independent Research' },
                        { id: 'cfs3-community', name: 'Engaging with the Scholarly Community' },
                        { id: 'cfs3-lifelong', name: 'Lifelong Learning in Sanskrit' }
                    ]
                }
            };

            const courses = {
                course1: {
                    name: "SAN Course I",
                    modules: ['sanskrit-basics', 'sabda-rupa', 'dhatu-rupa', 'karaka-vibhakti', 'sandhi', 'samasa', 'lakara', 'prayoga', 'ashtadhyayi-core', 'ashtadhyayi-technical-terms', 'laghu-siddhanta-kaumudi', 'siddhanta-kaumudi', 'katyayana-varttika', 'patanjali-maha-bhashya', 'reading-practice-1', 'conclusion-further-studies']
                },
                course2: {
                    name: "SAN Course II",
                    modules: ['chandas', 'alankara', 'vedic-sanskrit', 'kavya-shastra', 'nyaya-vaisheshika', 'mimamsa', 'reading-practice-2', 'conclusion-course-2']
                },
                course3: {
                    name: "SAN Course III",
                    modules: ['vedanta', 'sankhya-yoga', 'advanced-vyakarana', 'epigraphy-manuscriptology', 'reading-practice-3', 'conclusion-course-3']
                }
            };
            
            const achievementsMasterList = {
                'prathamam_sopanam': { name: 'प्रथमं सोपानम्', desc: 'Start your first lesson', icon: '🎓' },
                'jijnasuh': { name: 'जिज्ञासुः', desc: 'Complete 5 lessons', icon: '📚' },
                'abhyasi': { name: 'अभ्यासी', desc: 'Complete your first quiz', icon: '✏️' },
                'panditah': { name: 'पण्डितः', desc: 'Score 90%+ on a quiz', icon: '🏆' },
                'vagdevi_krpa': { name: 'वाग्देवी कृपा', desc: 'Start a 3-day learning streak', icon: '🔥' },
                'sarasvati_putrah': { name: 'सरस्वती पुत्रः', desc: 'Achieve a 7-day learning streak', icon: '🌟' },
                'mitra_sambhasanam': { name: 'मित्र सम्भाषणम्', desc: 'Have a chat with over 20 messages', icon: '💬' },
                'citrakarah': { name: 'चित्रकारः', desc: 'Generate your first image', icon: '🎨' }
            };


            // --- Functions ---
            const scrollToBottom = () => { messagesContainer.scrollTop = messagesContainer.scrollHeight; };
            
            const getAppId = () => typeof __app_id !== 'undefined' ? __app_id : 'sanskrit-chatbot';
            const getUserDocRef = () => window.firebase.doc(db, "artifacts", getAppId(), "users", userId);
            const getChatsColRef = () => window.firebase.collection(getUserDocRef(), "chats");
            const getTasksColRef = () => window.firebase.collection(getUserDocRef(), "tasks");
            const getChatDocRef = (chatId) => window.firebase.doc(getChatsColRef(), chatId);
            const getActiveChatRef = () => getChatDocRef(activeChatId);
            const getProgressDocRef = () => window.firebase.doc(getUserDocRef(), "progress", "main");

            const saveChatHistory = async () => {
                if (!activeChatId) return;
                const chatRef = getActiveChatRef();
                const dataToSave = {
                    messages: messages,
                    bookmarkedMessageIds: Array.from(bookmarkedMessageIds)
                };
                await window.firebase.setDoc(chatRef, dataToSave, { merge: true });
            };

            const listenForActiveChat = (chatId) => {
                unsubscribeChatDoc(); // Stop listening to the old chat
                if (!chatId) {
                    updateChatView(false);
                    return;
                }
                updateChatView(true);
                const chatRef = getChatDocRef(chatId);
                unsubscribeChatDoc = window.firebase.onSnapshot(chatRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        messages = data.messages || [];
                        bookmarkedMessageIds = new Set(data.bookmarkedMessageIds || []);
                        renderMessages();
                    } else {
                        // The active chat was deleted, handle this case
                        activeChatId = null;
                        updateChatView(false);
                    }
                });
            };

            const listenForChatHistoryList = () => {
                unsubscribeChatsCol();
                const q = window.firebase.query(getChatsColRef(), window.firebase.orderBy("createdAt", "desc"));
                unsubscribeChatsCol = window.firebase.onSnapshot(q, (snapshot) => {
                    allChatsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderChatHistoryList(searchChatsInput.value);
                });
            };

            const renderChatHistoryList = (filter = '') => {
                chatHistoryList.innerHTML = '';
                const lowerCaseFilter = filter.toLowerCase();
                
                const chats = allChatsCache.filter(chat => {
                    const title = chat.title || chat.messages.find(m => m.sender === 'user')?.text || chat.messages[0]?.text || '';
                    const chatContent = title.toLowerCase();
                    return chatContent.includes(lowerCaseFilter);
                });

                const pinnedChats = chats.filter(c => c.isPinned);
                const recentChats = chats.filter(c => !c.isPinned);

                if (pinnedChats.length > 0) {
                    const pinnedHeader = `<h3 class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Pinned</h3>`;
                    chatHistoryList.insertAdjacentHTML('beforeend', pinnedHeader);
                    pinnedChats.forEach(chat => createChatItem(chat));
                }

                if (recentChats.length > 0) {
                    const recentHeader = `<h3 class="mt-2 px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Recent</h3>`;
                    chatHistoryList.insertAdjacentHTML('beforeend', recentHeader);
                    recentChats.forEach(chat => createChatItem(chat));
                }

                if (chats.length === 0) {
                    chatHistoryList.innerHTML = `<p class="text-center text-gray-500 text-sm p-4">No chats found.</p>`;
                }
            };

            const createChatItem = (chat) => {
                const container = document.createElement('div');
                container.className = `chat-item relative p-2 rounded-lg cursor-pointer transition-colors ${chat.id === activeChatId ? 'bg-cyan-500/20' : 'hover:bg-gray-700/50'}`;
                container.dataset.chatId = chat.id;

                const titleText = chat.title || chat.messages.find(m => m.sender === 'user')?.text || chat.messages[0]?.text || 'New Chat';
                
                container.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="chat-title text-sm truncate pr-12">${titleText}</span>
                    </div>
                    <div class="chat-item-actions absolute right-1 top-1/2 -translate-y-1/2 flex items-center gap-1 bg-gray-800/80 p-1 rounded-md">
                        <button class="pin-chat-btn p-1 hover:text-cyan-400" title="Pin Chat">${chat.isPinned ? '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="text-cyan-400"><path d="M16 3a1 1 0 0 1 1 1v5.268l2.56 2.56a1 1 0 0 1 .293.707V14a1 1 0 0 1-1 1h-4.586l-2.433 4.865a1 1 0 0 1-1.78-.9l.83-4.975H7a1 1 0 0 1-1-1v-1.465a1 1 0 0 1 .293-.707L8.732 9.27V4a1 1 0 0 1 1-1h6z"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 3a1 1 0 0 1 1 1v5.268l2.56 2.56a1 1 0 0 1 .293.707V14a1 1 0 0 1-1 1h-4.586l-2.433 4.865a1 1 0 0 1-1.78-.9l.83-4.975H7a1 1 0 0 1-1-1v-1.465a1 1 0 0 1 .293-.707L8.732 9.27V4a1 1 0 0 1 1-1h6z"/></svg>'}</button>
                        <button class="rename-chat-btn p-1 hover:text-green-400" title="Rename Chat"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                        <button class="delete-chat-btn p-1 hover:text-red-400" title="Delete Chat"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                    </div>
                `;
                chatHistoryList.appendChild(container);
            }
            
            const updateChatView = (hasActiveChat) => {
                if(hasActiveChat) {
                    messagesContainer.classList.remove('hidden');
                    inputArea.classList.remove('hidden');
                    noActiveChatScreen.classList.add('hidden');
                } else {
                    messagesContainer.classList.add('hidden');
                    inputArea.classList.add('hidden');
                    noActiveChatScreen.classList.remove('hidden');
                    messages = [];
                    renderMessages();
                }
            };

            const getTodaysTasks = async () => {
                if (!userId) return null;

                const now = new Date();
                const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);

                const startTimestamp = window.firebase.Timestamp.fromDate(startOfDay);
                const endTimestamp = window.firebase.Timestamp.fromDate(endOfDay);

                const tasksColRef = getTasksColRef();
                const q = window.firebase.query(tasksColRef, 
                    window.firebase.where('taskDateTime', '>=', startTimestamp),
                    window.firebase.where('taskDateTime', '<=', endTimestamp)
                );

                try {
                    const querySnapshot = await window.firebase.getDocs(q);
                    if (querySnapshot.empty) {
                        return null;
                    }

                    let tasksText = '**अद्यतन कार्याणि (Tasks for today):**\n';
                    const tasks = [];
                    querySnapshot.forEach(doc => {
                        tasks.push(doc.data());
                    });
                    
                    // Sort tasks by time
                    tasks.sort((a, b) => a.taskDateTime.seconds - b.taskDateTime.seconds);

                    tasks.forEach(task => {
                        const taskDate = task.taskDateTime.toDate();
                        const timeString = taskDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        tasksText += `- ${task.description} at ${timeString}\n`;
                    });

                    return {
                        id: Date.now() + Math.random(),
                        sender: 'bot',
                        text: tasksText.trim(),
                        translation: null
                    };

                } catch (error) {
                    console.error("Error fetching today's tasks:", error);
                    return null;
                }
            };

            const createNewChat = async (initialPrompt = null) => {
                const chatsColRef = getChatsColRef();
                try {
                    let initialMessages = [];
                    let chatTitle = '';

                    const todaysTasksMessage = await getTodaysTasks();
                    if (todaysTasksMessage) {
                        initialMessages.push(todaysTasksMessage);
                    }

                    if (initialPrompt) {
                        initialMessages.push({ id: Date.now(), text: initialPrompt, sender: 'system' });
                        chatTitle = `Practice: ${initialPrompt.split('about ')[1]}`;
                    } else {
                        const subhashita = getRandomSubhashita();
                        const subhashitaMessage = {
                            id: Date.now(),
                            sender: 'bot',
                            text: `**द्यतनस्य सुभाषितम्:**\n\n*${subhashita.verse}*\n\n**अर्थः:** ${subhashita.translation}\n\n**विवरणम्:** ${subhashita.explanation}`
                        };
                        initialMessages.push(subhashitaMessage, initialMessage);
                    }

                    const newChatDoc = await window.firebase.addDoc(chatsColRef, {
                        createdAt: window.firebase.serverTimestamp(),
                        messages: initialMessages,
                        bookmarkedMessageIds: [],
                        isPinned: false,
                        title: chatTitle
                    });
                    
                    await window.firebase.updateDoc(getUserDocRef(), { activeChatId: newChatDoc.id });

                    if (initialPrompt) {
                        getBotResponse(); // Get the first response for the practice scenario
                    }
                    
                    toggleHistorySidebar(false);
                } catch (error) {
                    console.error("Error creating new chat:", error);
                }
            };

            const executeDeleteAllChats = async () => {
                const chatsColRef = getChatsColRef();
                const chatsSnapshot = await window.firebase.getDocs(chatsColRef);
                const batch = window.firebase.writeBatch(db);
                chatsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                await window.firebase.updateDoc(getUserDocRef(), { activeChatId: null });
                confirmationModal.classList.add('hidden');
            };

            const deleteSingleChat = async (chatId) => {
                await window.firebase.deleteDoc(getChatDocRef(chatId));
                if (chatId === activeChatId) {
                    const nextChat = allChatsCache.find(c => c.id !== chatId) || null;
                    await window.firebase.updateDoc(getUserDocRef(), { activeChatId: nextChat?.id || null });
                }
                confirmationModal.classList.add('hidden');
            };

            const togglePinChat = async (chatId) => {
                const chat = allChatsCache.find(c => c.id === chatId);
                if (!chat) return;
                await window.firebase.updateDoc(getChatDocRef(chatId), { isPinned: !chat.isPinned });
            };

            const renameChat = async (chatId, newTitle) => {
                await window.firebase.updateDoc(getChatDocRef(chatId), { title: newTitle });
            };

            const toggleBookmark = (messageId) => {
                if (bookmarkedMessageIds.has(messageId)) {
                    bookmarkedMessageIds.delete(messageId);
                } else {
                    bookmarkedMessageIds.add(messageId);
                }
                saveChatHistory();
            };
            
            const exportChat = () => {
                if (!activeChatId || messages.length === 0) {
                    console.log("No active chat to export.");
                    return;
                }

                let chatContent = `Sanskrit Mitra Chat\nExported on: ${new Date().toLocaleString()}\n\n---\n\n`;
                messages.forEach(msg => {
                    const prefix = msg.sender === 'user' ? 'User' : 'Mitra';
                    chatContent += `${prefix}: ${msg.text}\n`;
                    if (msg.translation) {
                        chatContent += `Translation: ${msg.translation}\n`;
                    }
                    if (msg.imageURL) {
                        chatContent += `[Image was generated with prompt: "${msg.text}"]\n`;
                    }
                    chatContent += `\n`;
                });

                const blob = new Blob([chatContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const chatInfo = allChatsCache.find(c => c.id === activeChatId);
                const chatTitle = chatInfo?.title || `chat-${activeChatId.substring(0, 5)}`;
                link.download = `sanskrit-mitra-${chatTitle.replace(/[\s\W]+/g, '_')}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const addMessageToDOM = (message) => {
                if (message.sender === 'system') return;

                const isBookmarked = bookmarkedMessageIds.has(message.id);
                const msgWrapper = document.createElement('div');
                msgWrapper.className = `flex items-end gap-2 message-enter ${message.sender === 'user' ? 'justify-end' : 'justify-start'}`;
                msgWrapper.id = `message-${message.id}`;
                
                let avatar = message.sender === 'bot' ? `<div class="w-8 h-8 rounded-full bg-cyan-500 flex items-center justify-center text-white font-bold text-sm flex-shrink-0">म</div>` : '';

                const msgBubble = document.createElement('div');
                const bubbleTypeClass = message.sender === 'user' ? 'user-bubble' : 'bot-bubble';
                msgBubble.className = `max-w-[85%] sm:max-w-md p-3 rounded-2xl relative group message-bubble ${bubbleTypeClass}`;
                
                if (message.imageURL) {
                    const img = document.createElement('img');
                    img.src = message.imageURL;
                    img.className = 'rounded-md mb-2 max-w-full h-auto';
                    img.onerror = () => { img.src = `https://placehold.co/400x400/374151/9ca3af?text=Image+Error`; };
                    msgBubble.appendChild(img);
                }

                const textContainer = document.createElement('div');
                textContainer.className = 'message-content';
                const textElement = document.createElement('div');
                // For generated images, use a smaller font for the prompt text
                textElement.className = message.imageURL ? 'text-sm' : 'font-devanagari text-lg';
                
                // Convert Markdown bold to HTML bold and render HTML
                let processedText = message.text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                textElement.innerHTML = processedText;

                textContainer.appendChild(textElement);
                
                if (message.translation) {
                    const translationContainer = document.createElement('div');
                    translationContainer.className = 'translation-content hidden mt-2 p-2 border-t border-gray-600';
                    translationContainer.innerHTML = `<p class="text-sm text-gray-300">${message.translation}</p>`;
                    textContainer.appendChild(translationContainer);
                }

                msgBubble.appendChild(textContainer);
                
                const controlsContainer = document.createElement('div');
                let controlsHTML = '';

                const bookmarkSVG = isBookmarked 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400 pointer-events-none"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300 pointer-events-none"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>`;
                
                const bookmarkBtn = `<button data-bookmark-id="${message.id}" class="bookmark-btn p-1.5 bg-gray-900/50 rounded-full hover:bg-cyan-600 transition-all opacity-0 group-hover:opacity-100" aria-label="Bookmark message">${bookmarkSVG}</button>`;
                
                if (message.sender === 'bot' && !message.text.includes("kshamyatām")) {
                    controlsContainer.className = 'absolute -bottom-2 -right-2 flex gap-1';
                    const translateBtn = message.translation ? `<button data-translate-id="${message.id}" class="translate-btn p-1.5 bg-gray-900/50 rounded-full hover:bg-cyan-600 transition-all opacity-0 group-hover:opacity-100" aria-label="Translate message"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300 pointer-events-none"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="m7 2 3.5 3.5"/><path d="m14 18 3 3 3-3"/><path d="M17 10v11"/></svg></button>` : '';
                    const speakBtn = message.imageURL ? '' : `<button data-speak-id="${message.id}" class="speak-btn p-1.5 bg-gray-900/50 rounded-full hover:bg-cyan-600 transition-all opacity-0 group-hover:opacity-100" aria-label="Speak message"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300 pointer-events-none"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></button>`;
                    controlsHTML = `${bookmarkBtn}${translateBtn}<button data-copy-id="${message.id}" class="copy-btn p-1.5 bg-gray-900/50 rounded-full hover:bg-cyan-600 transition-all opacity-0 group-hover:opacity-100" aria-label="Copy message"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300 pointer-events-none"><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></svg></button>${speakBtn}`;
                } else if (message.sender === 'user') {
                    controlsContainer.className = 'absolute -bottom-2 -left-2 flex gap-1';
                    controlsHTML = `${bookmarkBtn}<button data-edit-id="${message.id}" class="edit-btn p-1.5 bg-gray-900/50 rounded-full hover:bg-cyan-600 transition-all opacity-0 group-hover:opacity-100" aria-label="Edit message"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300 pointer-events-none"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>`;
                }
                controlsContainer.innerHTML = controlsHTML;
                msgBubble.appendChild(controlsContainer);
                
                msgWrapper.innerHTML = avatar;
                msgWrapper.appendChild(msgBubble);
                messagesContainer.appendChild(msgWrapper);
                scrollToBottom();
            };

            const renderMessages = () => {
                messagesContainer.innerHTML = '';
                messages.forEach(addMessageToDOM);
            };

            const setLoadingState = (state, type = 'typing') => {
                isLoading = state;
                inputField.disabled = state;
                sendBtn.disabled = state || (!inputField.value.trim() && !currentFile);
                micBtn.disabled = state;
                fileBtn.disabled = state;
                toolsMenuBtn.disabled = state;
                regenerateBtn.disabled = state || !messages.some(m => m.sender === 'user');

                const existingLoader = document.getElementById('loading-indicator');
                if (existingLoader) existingLoader.remove();

                if (state) {
                    sendBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');

                    const loader = document.createElement('div');
                    loader.id = 'loading-indicator';
                    loader.className = 'flex items-end gap-2 justify-start';
                    
                    const icon = type === 'searching' 
                        ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`
                        : 'म';
                    
                    const text = type === 'searching' ? 'Mitra is searching...' : (type === 'summarizing' ? 'Mitra is summarizing...' : 'Mitra is typing...');
                    
                    loader.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-cyan-500 flex items-center justify-center text-white font-bold text-sm flex-shrink-0">${icon}</div>
                        <div class="max-w-xs p-3 rounded-2xl bg-gray-800 text-gray-400 rounded-bl-none italic">${text}</div>
                    `;
                    messagesContainer.appendChild(loader);
                    scrollToBottom();
                } else {
                    sendBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                }
            };

            const handleSendMessage = async () => {
                const text = inputField.value.trim();
                if ((text || currentFile) && !isLoading) {
                    
                    let userPrompt = text;
                    let fileInfo = null;

                    if (currentFile) {
                        if (currentFile.type === 'application/pdf') {
                            userPrompt = `Based on the following document text: """${currentFile.extractedText}"""\n\nUser Question: ${text || 'Please summarize this document.'}`;
                            fileInfo = { fileName: currentFile.file.name, type: 'PDF' };
                        } else if (currentFile.type.startsWith('image/')) {
                            fileInfo = { image: currentFile, imageURL: currentFile.url };
                        }
                    }

                    const newUserMessage = { 
                        id: Date.now(), 
                        text: text || `File attached: ${currentFile.file.name}`,
                        sender: 'user',
                        ...fileInfo
                    };
                    messages.push(newUserMessage);
                    await saveChatHistory();
                    
                    inputField.value = '';
                    currentFile = null;
                    filePreviewContainer.classList.add('hidden');
                    filePreviewContent.innerHTML = '';
                    viewModeIndicator.textContent = 'Your AI Sanskrit Companion'; // Reset indicator
                    updateInputButtons();
                    getBotResponse(userPrompt, fileInfo?.image);
                }
            };

            const callGeminiAPI = async (payload, signal) => {
                const apiKey = "AIzaSyAmafoWE-zq0piZUInd8g0dWKLXyr0hJpg";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload),
                    signal
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                
                if (payload.generationConfig?.responseMimeType === "application/json") {
                    return result.candidates?.[0]?.content?.parts?.[0]?.text;
                }
                return result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
            }

            const getBotResponse = async (promptOverride = null, imageFile = null) => {
                setLoadingState(true, 'typing');
                abortController = new AbortController();

                const systemPrompt = `You are a friendly and expert Sanskrit tutor bot named 'Mitra'. You are an expert in Pāṇinian grammar (Aṣṭādhyāyī).
                
                **Special Modes**:
                - If the user's prompt starts with \`[DEEP THINK]:\`, provide a more comprehensive, analytical, and in-depth response. Explore multiple perspectives, historical context, and philosophical implications of the topic. Your response should be significantly more detailed than a standard answer.

                Your primary capabilities are:
                1.  **Conversational Partner**: Converse in Sanskrit (Devanagari script). You can understand user input in English, and romanized versions of Telugu, Hindi, Tamil, Malayalam, Punjabi, Bengali, Marathi, Odia, and Roman Urdu.
                2.  **Grammar Expert**: Explain complex grammar topics like Sandhi, Samāsa, Kāraka, Vibhakti, Lakāra, and Prayoga. You can also explain specific sūtras from the Aṣṭādhyāyī.
                3.  **Grammar Checker**: If a user provides a Sanskrit sentence, check it for grammatical correctness. If there's an error, provide the correct sentence and a **brief, clear explanation** of the rule. **Bold** key terms in your explanation using Markdown (\`**term**\`).
                4.  **Declension & Conjugation Expert**: If a user asks for a declension table (e.g., "show declension of rāma", "rāma shabda") or a conjugation table (e.g. "conjugate path"), you MUST respond **ONLY** with the full table formatted in HTML. The table must have the class \`sanskrit-table\` and a proper \`<thead>\` and \`<tbody>\`.
                5.  **Alaṅkāra Expert**: Explain figures of speech (Alaṅkāra) with examples.
                6.  **Image & Document Analyst**: You can analyze images and text from documents to answer questions or summarize.
                
                **Response Rules**:
                -   Unless generating a table, your primary response language is **Sanskrit (Devanagari script)**.
                -   For grammar explanations, use simple language and bolding for emphasis.
                -   For table requests, the HTML table should be your **only** output.`;

                const chatHistory = [{ role: "user", parts: [{ text: systemPrompt }] }, { role: "model", parts: [{ text: "अस्तु। अहं सिद्धः अस्मि।" }] }];

                messages.forEach(msg => {
                    const role = msg.sender === 'user' ? 'user' : 'model';
                    const parts = [{ text: msg.text }];
                    if (msg.image) {
                        parts.push({
                            inlineData: {
                                mimeType: msg.image.type,
                                data: msg.image.data.split(',')[1]
                            }
                        });
                    }
                    chatHistory.push({ role, parts });
                });

                // Use the last message as the prompt if no override is given
                const lastMessage = chatHistory[chatHistory.length - 1];
                if (promptOverride) {
                    lastMessage.parts[0].text = promptOverride;
                }
                if (imageFile) {
                    lastMessage.parts.push({
                        inlineData: {
                            mimeType: imageFile.type,
                            data: imageFile.data.split(',')[1]
                        }
                    });
                }
                
                try {
                    const rawBotText = await callGeminiAPI({ contents: chatHistory }, abortController.signal);
                    
                    const searchRegex = /\[SEARCH: (.*?)\]\n?/;
                    const searchMatch = rawBotText.match(searchRegex);
                    let sanskritText = rawBotText;

                    if (searchMatch && !abortController.signal.aborted) {
                        setLoadingState(true, 'searching');
                        await new Promise(resolve => setTimeout(resolve, 1500)); 
                        if (abortController.signal.aborted) throw new Error('AbortError');
                        sanskritText = rawBotText.replace(searchRegex, '').trim();
                    } 
                    
                    if (abortController.signal.aborted) throw new Error('AbortError');

                    // Don't translate if the response is a table
                    const isTable = sanskritText.trim().startsWith('<table');
                    let englishTranslation = null;
                    if (!isTable) {
                        const translationPayload = {
                            contents: [ { role: "user", parts: [{ text: `Translate the following Sanskrit text to English. Respond ONLY with the English translation.\n\nSanskrit: "${sanskritText}"` }] } ]
                        };
                        englishTranslation = await callGeminiAPI(translationPayload, abortController.signal);
                    }

                    messages.push({ 
                        id: Date.now(), 
                        text: sanskritText || "क्षमाम् अर्हामि, अहं एतत् संसाधयितुं न शक्नोमि।", 
                        sender: 'bot',
                        translation: englishTranslation
                    });

                } catch (error) {
                    if (error.message === 'AbortError' || error.name === 'AbortError') {
                        console.log('Fetch aborted by user.');
                        messages.push({ id: Date.now(), text: "जननं स्थगितम्।", sender: 'bot' });
                    } else {
                        console.error("Error fetching bot response:", error);
                        messages.push({ id: Date.now(), text: "त्रुटिः अभवत्। कृपया पुनः प्रयतताम्।", sender: 'bot' });
                    }
                } finally {
                    if (!abortController.signal.aborted) {
                        await saveChatHistory();
                        setLoadingState(false);
                    }
                }
            };
            
            const startEditing = (editBtn) => {
                const messageId = parseInt(editBtn.dataset.editId);
                if (editingMessageId) { cancelEditing(editingMessageId); }
                editingMessageId = messageId;
                const message = messages.find(m => m.id === messageId);
                const messageNode = document.getElementById(`message-${messageId}`);
                const contentNode = messageNode.querySelector('.message-content');
                contentNode.innerHTML = `<input type="text" value="${message.text}" class="edit-input w-full bg-gray-600 text-white rounded-md p-1 focus:outline-none focus:ring-2 focus:ring-cyan-500"><div class="flex justify-end gap-2 mt-2"><button class="cancel-edit-btn text-xs text-gray-400 hover:text-white">Cancel</button><button class="save-edit-btn text-xs text-cyan-400 hover:text-cyan-300">Save & Resubmit</button></div>`;
                contentNode.querySelector('.edit-input').focus();
            };

            const saveEditing = async (messageId) => {
                const messageNode = document.getElementById(`message-${messageId}`);
                const input = messageNode.querySelector('.edit-input');
                const newText = input.value.trim();
                
                if (newText) {
                    const messageIndex = messages.findIndex(m => m.id === messageId);
                    if (messageIndex > -1) {
                        messages[messageIndex].text = newText;
                        messages.splice(messageIndex + 1);
                        await saveChatHistory();
                        getBotResponse();
                    }
                }
                editingMessageId = null;
            };

            const cancelEditing = (messageId) => {
                editingMessageId = null;
                renderMessages();
            };

            const updateInputButtons = () => {
                sendBtn.disabled = isLoading || (!inputField.value.trim() && !currentFile);
                clearInputBtn.classList.toggle('hidden', !inputField.value);
            };

            const toggleHistorySidebar = (forceOpen) => {
                const isOpen = historySidebar.classList.contains('translate-x-0');
                if (typeof forceOpen === 'boolean') {
                    if (forceOpen) {
                        historySidebar.classList.remove('-translate-x-full');
                        historySidebar.classList.add('translate-x-0');
                        sidebarOverlay.classList.remove('hidden');
                    } else {
                        historySidebar.classList.add('-translate-x-full');
                        historySidebar.classList.remove('translate-x-0');
                        sidebarOverlay.classList.add('hidden');
                    }
                } else {
                    historySidebar.classList.toggle('-translate-x-full');
                    historySidebar.classList.toggle('translate-x-0');
                    sidebarOverlay.classList.toggle('hidden');
                }
            };

            const showConfirmationModal = (action) => {
                currentModalAction = action;
                confirmationModal.classList.remove('hidden');
            };

            // --- Event Listeners ---
            if (menuBtn) menuBtn.addEventListener('click', () => toggleHistorySidebar());
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', () => toggleHistorySidebar(false));
            if (newChatBtn) newChatBtn.addEventListener('click', () => createNewChat());
            if (startNewChatBtn) startNewChatBtn.addEventListener('click', () => createNewChat());
            if (deleteAllChatsBtn) deleteAllChatsBtn.addEventListener('click', () => showConfirmationModal('deleteAll'));
            
            if (modalConfirmBtn) modalConfirmBtn.addEventListener('click', () => {
                if (currentModalAction === 'deleteAll') {
                    executeDeleteAllChats();
                } else if (currentModalAction && currentModalAction.type === 'deleteSingle') {
                    deleteSingleChat(currentModalAction.chatId);
                }
                currentModalAction = null;
            });
            if (modalCancelBtn) modalCancelBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                currentModalAction = null;
            });

            if (searchChatsInput) searchChatsInput.addEventListener('input', (e) => {
                renderChatHistoryList(e.target.value);
            });
            if (chatHistoryList) chatHistoryList.addEventListener('click', async (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;

                const chatId = chatItem.dataset.chatId;

                if (e.target.closest('.pin-chat-btn')) {
                    e.stopPropagation();
                    togglePinChat(chatId);
                } else if (e.target.closest('.delete-chat-btn')) {
                    e.stopPropagation();
                    showConfirmationModal({ type: 'deleteSingle', chatId: chatId });
                } else if (e.target.closest('.rename-chat-btn')) {
                    e.stopPropagation();
                    const titleSpan = chatItem.querySelector('.chat-title');
                    const currentTitle = titleSpan.textContent;
                    titleSpan.innerHTML = `<input type="text" class="rename-input bg-gray-700 text-white text-sm rounded w-full p-0.5" value="${currentTitle}">`;
                    const input = titleSpan.querySelector('input');
                    input.focus();
                    input.select();
                    input.onblur = () => {
                        renameChat(chatId, input.value);
                    };
                    input.onkeydown = (ev) => {
                        if (ev.key === 'Enter') {
                            input.blur();
                        } else if (ev.key === 'Escape') {
                            renderChatHistoryList(searchChatsInput.value);
                        }
                    };
                } else {
                    if (chatId !== activeChatId) {
                       await window.firebase.updateDoc(getUserDocRef(), { activeChatId: chatId });
                    }
                    toggleHistorySidebar(false);
                }
            });


            if (sendBtn) sendBtn.addEventListener('click', handleSendMessage);
            if (stopBtn) stopBtn.addEventListener('click', () => { 
                if (isLoading && abortController) { 
                    abortController.abort(); 
                    setLoadingState(false);
                    messages.push({ id: Date.now(), text: "जननं स्थगितम्।", sender: 'bot' });
                    saveChatHistory();
                } 
            });
            if (inputField) {
                inputField.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                    }
                });
                inputField.addEventListener('input', updateInputButtons);
            }
            if (clearInputBtn) clearInputBtn.addEventListener('click', () => { inputField.value = ''; updateInputButtons(); inputField.focus(); });
            
            if (SpeechRecognition && micBtn) {
                micBtn.addEventListener('click', () => { isRecognizing ? recognition.stop() : recognition.start(); });
            }

            if (fileBtn) fileBtn.addEventListener('click', () => fileInput.click());
            if (fileInput) fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                filePreviewContainer.classList.remove('hidden');
                filePreviewContent.innerHTML = `<div class="w-20 h-20 bg-gray-700 rounded-md flex items-center justify-center"><div class="w-8 h-8 border-4 border-gray-500 border-t-cyan-500 rounded-full animate-spin"></div></div><span class="text-sm text-gray-400">Processing...</span>`;
                updateInputButtons();

                try {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const base64Data = e.target.result;
                            currentFile = { file: file, data: base64Data, type: file.type };
                            filePreviewContent.innerHTML = `<img class="w-20 h-20 object-cover rounded-md" src="${base64Data}"> <span class="text-sm text-gray-300 truncate">${file.name}</span>`;
                            updateInputButtons();
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const typedarray = new Uint8Array(e.target.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            let fullText = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                fullText += textContent.items.map(item => item.str).join(' ');
                            }
                            currentFile = { file: file, type: file.type, extractedText: fullText };
                            filePreviewContent.innerHTML = `<div class="w-20 h-20 bg-gray-700 rounded-md flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg></div><span class="text-sm text-gray-300 truncate">${file.name}</span>`;
                            updateInputButtons();
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        throw new Error("Unsupported file type");
                    }
                } catch (error) {
                    console.error("File processing error:", error);
                    filePreviewContent.innerHTML = `<span class="text-sm text-red-400">Error processing file. Please try another.</span>`;
                    currentFile = null;
                    setTimeout(() => {
                        filePreviewContainer.classList.add('hidden');
                    }, 3000);
                }
            });
            if (removeFileBtn) removeFileBtn.addEventListener('click', () => {
                currentFile = null;
                fileInput.value = '';
                filePreviewContainer.classList.add('hidden');
                filePreviewContent.innerHTML = '';
                updateInputButtons();
            });

            if (regenerateBtn) regenerateBtn.addEventListener('click', async () => {
                if (isLoading || !messages.some(m => m.sender === 'user')) return;
                window.handleStopAudio();
                const lastBotMessageIndex = messages.findLastIndex(m => m.sender === 'bot');
                if (lastBotMessageIndex > -1) {
                    messages.splice(lastBotMessageIndex, 1);
                    await saveChatHistory();
                    getBotResponse();
                }
            });
            
            if (messagesContainer) messagesContainer.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                if (target.matches('.speak-btn')) window.handleSpeak(target);
                if (target.matches('.copy-btn')) window.handleCopyToClipboard(target);
                if (target.matches('.edit-btn')) startEditing(target);
                if (target.matches('.save-edit-btn')) saveEditing(editingMessageId);
                if (target.matches('.cancel-edit-btn')) cancelEditing(editingMessageId);
                if (target.matches('.bookmark-btn')) toggleBookmark(parseInt(target.dataset.bookmarkId));
                if (target.matches('.translate-btn')) window.handleTranslate(target);

            });
            
            // --- Tools Menu Logic ---
            if (toolsMenuBtn) {
                toolsMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toolsMenuDropdown.classList.toggle('hidden');
                });
            }
            document.addEventListener('click', (e) => {
                if (toolsMenuDropdown && !toolsMenuDropdown.classList.contains('hidden')) {
                    if (!toolsMenuBtn.contains(e.target) && !toolsMenuDropdown.contains(e.target)) {
                        toolsMenuDropdown.classList.add('hidden');
                    }
                }
            });
            if (toolsMenuDropdown) {
                toolsMenuDropdown.addEventListener('click', (e) => {
                    if (e.target.closest('button')) {
                        toolsMenuDropdown.classList.add('hidden');
                    }
                });
            }

            // --- Keyboard Shortcuts ---
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                if (e.altKey) {
                    e.preventDefault();
                    switch (e.key.toLowerCase()) {
                        case 'n':
                            newChatBtn.click();
                            break;
                        case 'c':
                            exportChat();
                            break;
                        case 'i':
                            imageGenBtn.click();
                            break;
                    }
                }
            });

            // --- Initialization and Auth Flow ---
            const setupFirebase = () => {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    try {
                        const firebaseConfig = JSON.parse(__firebase_config);
                        const app = window.firebase.initializeApp(firebaseConfig);
                        auth = window.firebase.getAuth(app);
                        db = window.firebase.getFirestore(app);
                        storage = window.firebase.getStorage(app);

                        window.firebase.onAuthStateChanged(auth, (user) => {
                            if (user) {
                                userId = user.uid;
                                loginScreen.classList.add('hidden');
                                dashboardScreen.classList.remove('hidden');
                                chatScreen.classList.add('hidden');

                                if (!alarmIntervalId) {
                                    alarmIntervalId = setInterval(checkTasksForAlarms, 60000); // Check every minute
                                }
                                
                                unsubscribeUserDoc = window.firebase.onSnapshot(getUserDocRef(), (doc) => {
                                    if (doc.exists()) {
                                        const data = doc.data();
                                        activeChatId = data.activeChatId || null;
                                        selectedVoice = data.selectedVoice || 'Achird';
                                        activeCourseId = data.activeCourseId || 'course1';
                                        applyTheme(data.theme || 'dark');
                                        listenForActiveChat(activeChatId);
                                        listenForChatHistoryList();
                                        initDashboard();
                                    } else {
                                        window.firebase.setDoc(getUserDocRef(), { uid: userId, selectedVoice: 'Achird', theme: 'dark', activeCourseId: 'course1' });
                                        activeChatId = null;
                                        listenForActiveChat(null);
                                        listenForChatHistoryList();
                                        initDashboard();
                                    }
                                });
                                
                                unsubscribeProgress = window.firebase.onSnapshot(getProgressDocRef(), (doc) => {
                                    if (doc.exists()) {
                                        learningProgress = doc.data();
                                    } else {
                                        // Initialize progress doc if it doesn't exist
                                        learningProgress = {
                                            lessons: {},
                                            quizzes: {},
                                            achievements: [],
                                            streak: {
                                                current: 0,
                                                longest: 0,
                                                lastActivityDate: null
                                            }
                                        };
                                        window.firebase.setDoc(getProgressDocRef(), learningProgress);
                                    }
                                    initDashboard();
                                });

                            } else {
                                userId = null;
                                activeChatId = null;
                                chatScreen.classList.add('hidden');
                                dashboardScreen.classList.add('hidden');
                                loginScreen.classList.remove('hidden');
                                unsubscribeUserDoc();
                                unsubscribeChatDoc();
                                unsubscribeChatsCol();
                                unsubscribeProgress();
                                if (alarmIntervalId) {
                                    clearInterval(alarmIntervalId);
                                    alarmIntervalId = null;
                                }
                            }
                        });
                    } catch (e) {
                         console.error("Failed to parse Firebase config:", e);
                         loginScreen.innerHTML = `<p class="text-red-500">Firebase configuration is invalid. App cannot run.</p>`;
                    }
                } else {
                    console.error("Firebase config not provided.");
                    loginScreen.innerHTML = `<p class="text-red-500">Firebase not configured. App cannot run.</p>`;
                }
            };
            
            setupFirebase();

            if (loginBtn) loginBtn.addEventListener('click', async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await window.firebase.signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await window.firebase.signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                }
            });

            if (logoutBtn) logoutBtn.addEventListener('click', () => {
                window.firebase.signOut(auth);
            });

            // --- Voice Selection ---
            let synthesisVoices = [];
            const populateVoiceOptions = () => {
                synthesisVoices = window.speechSynthesis.getVoices();
                voiceOptionsContainer.innerHTML = '';
                if (synthesisVoices.length === 0) {
                    voiceOptionsContainer.innerHTML = '<p class="text-gray-400 text-center col-span-full">No voices available in your browser.</p>';
                    return;
                }
                
                synthesisVoices.forEach(voice => {
                    const isChecked = voice.name === selectedVoice;
                    const option = document.createElement('label');
                    option.className = 'voice-option flex items-center p-3 bg-gray-700 rounded-lg border-2 border-transparent cursor-pointer hover:border-cyan-600 transition-colors';
                    option.innerHTML = `
                        <input type="radio" name="voice" value="${voice.name}" class="hidden" ${isChecked ? 'checked' : ''}>
                        <div class="flex-1">
                            <div class="font-semibold text-white">${voice.name}</div>
                            <div class="text-sm text-gray-400">${voice.lang} ${voice.default ? '(default)' : ''}</div>
                        </div>
                        <div class="w-5 h-5 rounded-full border-2 border-gray-500 flex items-center justify-center">
                            ${isChecked ? '<div class="w-2.5 h-2.5 bg-cyan-500 rounded-full"></div>' : ''}
                        </div>
                    `;
                    voiceOptionsContainer.appendChild(option);
                });
            };

            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceOptions;
            }

            if (voiceSelectBtn) voiceSelectBtn.addEventListener('click', () => {
                populateVoiceOptions();
                voiceModal.classList.remove('hidden');
            });
            if (voiceModalCloseBtn) voiceModalCloseBtn.addEventListener('click', () => voiceModal.classList.add('hidden'));
            if (voiceModal) voiceModal.addEventListener('click', (e) => {
                if (e.target === voiceModal) {
                    voiceModal.classList.add('hidden');
                }
            });

            if (voiceOptionsContainer) voiceOptionsContainer.addEventListener('change', async (e) => {
                if (e.target.name === 'voice') {
                    selectedVoice = e.target.value;
                    await window.firebase.updateDoc(getUserDocRef(), { selectedVoice: selectedVoice });
                    populateVoiceOptions(); // Re-render to show selection
                    setTimeout(() => voiceModal.classList.add('hidden'), 300);
                }
            });

            // --- Theme Toggle ---
            const applyTheme = (theme) => {
                currentTheme = theme;
                if (theme === 'light') {
                    document.documentElement.classList.add('light');
                    document.documentElement.classList.remove('dark');
                    themeIconMoon.classList.add('hidden');
                    themeIconSun.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('light');
                    document.documentElement.classList.add('dark');
                    themeIconSun.classList.add('hidden');
                    themeIconMoon.classList.remove('hidden');
                }
            };

            if (themeToggleBtn) themeToggleBtn.addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                applyTheme(newTheme);
                if (userId) {
                    window.firebase.updateDoc(getUserDocRef(), { theme: newTheme });
                }
            });
            
            // --- Image Generation ---
            const callImagenAPI = async (prompt) => {
                const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`Imagen API request failed with status ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    } else {
                        throw new Error("Invalid response from Imagen API");
                    }
                } catch (error) {
                    console.error("Image generation error:", error);
                    return null;
                }
            };

            if (imageGenBtn) imageGenBtn.addEventListener('click', () => {
                if (!activeChatId) {
                    // You could show a small toast/modal message here
                    console.log("Please start a new chat first.");
                    return;
                }
                imageGenModal.classList.remove('hidden');
                imageGenPrompt.focus();
            });
            if (imageGenCloseBtn) imageGenCloseBtn.addEventListener('click', () => imageGenModal.classList.add('hidden'));
            if (imageGenModal) imageGenModal.addEventListener('click', (e) => {
                if (e.target === imageGenModal) imageGenModal.classList.add('hidden');
            });

            if (imageGenSubmitBtn) imageGenSubmitBtn.addEventListener('click', async () => {
                const prompt = imageGenPrompt.value.trim();
                if (!prompt) return;

                imageGenSubmitBtn.disabled = true;
                imageGenLoader.classList.remove('hidden');
                imageGenLoader.classList.add('flex');

                const imageUrl = await callImagenAPI(prompt);

                imageGenSubmitBtn.disabled = false;
                imageGenLoader.classList.add('hidden');
                imageGenLoader.classList.remove('flex');
                imageGenModal.classList.add('hidden');
                imageGenPrompt.value = '';

                if (imageUrl) {
                    const newImageMessage = {
                        id: Date.now(),
                        text: `*Image generated with prompt: "${prompt}"*`,
                        sender: 'bot',
                        imageURL: imageUrl,
                        translation: null
                    };
                    messages.push(newImageMessage);
                    await saveChatHistory();
                } else {
                    const errorMessage = {
                        id: Date.now(),
                        text: "क्षमाम् अर्हामि, अहं चित्रं जनयितुं न शक्नोमि। कृपया पुनः प्रयतताम्।",
                        sender: 'bot',
                        translation: "I'm sorry, I couldn't generate the image. Please try again."
                    };
                    messages.push(errorMessage);
                    await saveChatHistory();
                }
            });

            // --- Task Scheduler & Alarms ---
            const populateTimezones = () => {
                const timezones = [
                    'UTC', 'GMT', 'Europe/London', 'Europe/Paris', 'Europe/Berlin',
                    'Africa/Cairo', 'Asia/Dubai', 'Asia/Kolkata', 'Asia/Singapore',
                    'Asia/Tokyo', 'Australia/Sydney', 'America/New_York', 'America/Chicago',
                    'America/Denver', 'America/Los_Angeles', 'America/Sao_Paulo'
                ];
                const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                if (!timezones.includes(userTimezone)) {
                    timezones.unshift(userTimezone);
                }
                taskTimezone.innerHTML = timezones.map(tz => `<option value="${tz}" ${tz === userTimezone ? 'selected' : ''}>${tz}</option>`).join('');
            };

            const requestNotificationPermission = async () => {
                if (!('Notification' in window)) {
                    console.error('This browser does not support desktop notification');
                    return 'denied';
                }
                if (Notification.permission === 'granted') {
                    return 'granted';
                }
                if (Notification.permission !== 'denied') {
                    const permission = await Notification.requestPermission();
                    return permission;
                }
                return 'denied';
            };

            const checkTasksForAlarms = async () => {
                if (!userId || Notification.permission !== 'granted') return;

                const now = window.firebase.Timestamp.now();
                const tasksColRef = getTasksColRef();
                const q = window.firebase.query(tasksColRef,
                    window.firebase.where('alarmEnabled', '==', true),
                    window.firebase.where('alarmTriggered', '==', false),
                    window.firebase.where('taskDateTime', '<=', now)
                );

                try {
                    const querySnapshot = await window.firebase.getDocs(q);

                    if (!querySnapshot.empty && alarmSound.paused) {
                        alarmSound.play().catch(e => console.error("Error playing alarm sound:", e));
                    }

                    querySnapshot.forEach(doc => {
                        const task = doc.data();
                        const notification = new Notification('Sanskrit Mitra Task Reminder', { 
                            body: task.description, 
                            icon: './favicon.ico',
                            tag: doc.id // Use a tag to manage notifications
                        });

                        const stopAlarm = () => {
                            if (!alarmSound.paused) {
                                alarmSound.pause();
                                alarmSound.currentTime = 0;
                            }
                        };

                        notification.onclick = () => {
                            stopAlarm();
                            window.focus();
                        };
                        notification.onclose = stopAlarm;

                        window.firebase.updateDoc(doc.ref, { alarmTriggered: true });
                    });
                } catch (error) { console.error("Error checking for task alarms:", error); }
            };

            const saveTask = async () => {
                const description = taskDescription.value.trim();
                const date = taskDate.value;
                const time = taskTime.value;
                const alarmEnabled = document.getElementById('task-alarm').checked;

                if (!description || !date || !time) {
                    alert('Please fill out all task fields.'); // Replace with a better modal later
                    return;
                }

                if (alarmEnabled && Notification.permission !== 'granted') {
                    const permission = await requestNotificationPermission();
                    if (permission !== 'granted') {
                        console.warn('Notification permission denied. The alarm will be saved but not displayed.');
                    }
                }

                const [year, month, day] = date.split('-');
                const [hour, minute] = time.split(':');
                const taskDateTime = new Date(year, month - 1, day, hour, minute);
                
                const task = {
                    description: description,
                    taskDateTime: window.firebase.Timestamp.fromDate(taskDateTime),
                    timeZone: taskTimezone.value,
                    isCompleted: false,
                    alarmEnabled: alarmEnabled,
                    alarmTriggered: false,
                    createdAt: window.firebase.serverTimestamp()
                };

                try {
                    await window.firebase.addDoc(getTasksColRef(), task);
                    taskSchedulerModal.classList.add('hidden');
                    // Add a confirmation message to the chat
                    const confirmationMessage = {
                        id: Date.now(),
                        sender: 'bot',
                        text: `**कार्यं रक्षितम् (Task Saved):** ${description} for ${taskDateTime.toLocaleString()}`,
                        translation: null
                    };
                    messages.push(confirmationMessage);
                    await saveChatHistory();

                } catch (error) {
                    console.error("Error saving task:", error);
                    alert('Failed to save task. Please try again.');
                }
            };
            
            if (scheduleTaskBtn) scheduleTaskBtn.addEventListener('click', () => {
                populateTimezones();
                taskDescription.value = '';
                taskDate.value = '';
                taskTime.value = '';
                taskSchedulerModal.classList.remove('hidden');
            });
            if (taskModalCloseBtn) taskModalCloseBtn.addEventListener('click', () => taskSchedulerModal.classList.add('hidden'));
            if (saveTaskBtn) saveTaskBtn.addEventListener('click', saveTask);
            if (guidedLearningBtn) {
                guidedLearningBtn.addEventListener('click', () => {
                    openLessonSelectionModal(); // Open with no specific module to show all modules
                });
            }
            if (deepThinkBtn) {
                deepThinkBtn.addEventListener('click', () => {
                    const deepThinkPrefix = '[DEEP THINK]: ';
                    if (inputField.value.startsWith(deepThinkPrefix)) {
                        inputField.value = inputField.value.substring(deepThinkPrefix.length);
                        viewModeIndicator.textContent = 'Your AI Sanskrit Companion';
                    } else {
                        inputField.value = `${deepThinkPrefix}${inputField.value}`;
                        viewModeIndicator.textContent = 'Deep Think Mode Activated';
                    }
                    inputField.focus();
                });
            }


            // --- Global Functions ---
            window.handleStopAudio = () => {
                if (window.speechSynthesis && window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }
                playingMessageId = null;
                window.updateAudioIcons();
            };
            window.updateAudioIcons = () => { document.querySelectorAll('.speak-btn').forEach(btn => { const id = parseInt(btn.dataset.speakId); btn.innerHTML = id === playingMessageId ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400 pointer-events-none"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300 pointer-events-none"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>`; }); stopAudioContainer.innerHTML = ''; if (playingMessageId) { const stopBtn = document.createElement('button'); stopBtn.className = "p-1 rounded-full hover:bg-red-500/20 transition-colors"; stopBtn.ariaLabel = "Stop audio"; stopBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><circle cx="12" cy="12" r="10"/><rect x="9" y="9" width="6" height="6"/></svg>`; stopBtn.onclick = window.handleStopAudio; stopAudioContainer.appendChild(stopBtn); } };
            window.handleSpeak = (speakBtn) => {
                const messageId = parseInt(speakBtn.dataset.speakId);

                if (window.speechSynthesis.speaking && playingMessageId === messageId) {
                    window.speechSynthesis.cancel();
                    return;
                }

                if (window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }
                
                const message = messages.find(m => m.id === messageId);
                if (!message || message.imageURL) return;

                const textToSpeak = message.text.replace(/<[^>]*>/g, ' ');
                const utterance = new SpeechSynthesisUtterance(textToSpeak);

                const voice = window.speechSynthesis.getVoices().find(v => v.name === selectedVoice);
                if (voice) {
                    utterance.voice = voice;
                } else {
                    const sanskritVoice = window.speechSynthesis.getVoices().find(v => v.lang.startsWith('sa-IN'));
                    if (sanskritVoice) utterance.voice = sanskritVoice;
                }

                utterance.onstart = () => {
                    playingMessageId = messageId;
                    window.updateAudioIcons();
                };

                utterance.onend = () => {
                    playingMessageId = null;
                    window.updateAudioIcons();
                };
                
                utterance.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror', event);
                    playingMessageId = null;
                    window.updateAudioIcons();
                };

                window.speechSynthesis.speak(utterance);
            };
            window.handleCopyToClipboard = (copyBtn) => { const messageId = parseInt(copyBtn.dataset.copyId); const message = messages.find(m => m.id === messageId); if (!message) return; const textArea = document.createElement('textarea'); let textToCopy = message.text; if (message.translation) { textToCopy += `\n\n${message.translation}`; } textArea.value = textToCopy; document.body.appendChild(textArea); textArea.select(); try { document.execCommand('copy'); copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400 pointer-events-none"><polyline points="20 6 9 17 4 12"></polyline></svg>`; setTimeout(() => { copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300 pointer-events-none"><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></svg>`; }, 2000); } catch (err) { console.error('Failed to copy text: ', err); } document.body.removeChild(textArea); };
            window.handleTranslate = (translateBtn) => { const messageId = parseInt(translateBtn.dataset.translateId); const messageNode = document.getElementById(`message-${messageId}`); if (!messageNode) return; const translationContainer = messageNode.querySelector('.translation-content'); if (translationContainer) { translationContainer.classList.toggle('hidden'); } };
        
            // --- Learning Dashboard and Quiz Logic ---
            const initDashboard = () => {
                const course = courses[activeCourseId];
                if (!course) {
                    console.error("Invalid course ID:", activeCourseId);
                    return;
                }

                dashboardTitle.textContent = course.name;
                modulesGrid.innerHTML = '';

                if (course.modules.length === 0) {
                    modulesGrid.innerHTML = `<p class="text-center text-gray-400 col-span-full">Modules for this course are coming soon.</p>`;
                    return;
                }

                course.modules.forEach(moduleId => {
                    const module = modules[moduleId];
                    if (!module) return;

                    const moduleProgress = learningProgress[moduleId] || { lessons: {}, quizzes: {} };
                    const completedLessons = Object.values(moduleProgress.lessons).filter(Boolean).length;
                    const totalLessons = module.lessons.length;
                    const progressPercentage = totalLessons > 0 ? (completedLessons / totalLessons) * 100 : 0;
                    
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800/50 backdrop-blur-sm p-6 rounded-xl shadow-lg flex flex-col';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-cyan-400 pr-2">${module.name}</h3>
                        </div>
                        <div class="mt-4 flex-grow">
                            <p class="text-sm text-gray-400">Progress</p>
                            <div class="w-full bg-gray-700 rounded-full h-2.5 mt-1">
                                <div class="bg-cyan-500 h-2.5 rounded-full" style="width: ${progressPercentage}%"></div>
                            </div>
                            <p class="text-xs text-right text-gray-500 mt-1">${completedLessons} / ${totalLessons} Lessons</p>
                        </div>
                        <div class="mt-6 flex gap-2">
                            <button class="start-lesson-btn flex-1 px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500 transition-colors" data-module-id="${moduleId}">Start Lesson</button>
                            <button class="start-quiz-btn flex-1 px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg hover:bg-cyan-500 transition-colors" data-module-id="${moduleId}">Take Quiz</button>
                        </div>
                    `;
                    modulesGrid.appendChild(card);
                });
            };

            modulesGrid.addEventListener('click', (e) => {
                if (e.target.matches('.start-lesson-btn, .start-lesson-btn *')) {
                    const moduleId = e.target.closest('.start-lesson-btn').dataset.moduleId;
                    openLessonSelectionModal(moduleId);
                } else if (e.target.matches('.start-quiz-btn, .start-quiz-btn *')) {
                    const moduleId = e.target.closest('.start-quiz-btn').dataset.moduleId;
                    openQuizSetupModal(moduleId);
                }
            });

            const openLessonModal = async (moduleId, lessonIndex = 0) => {
                const module = modules[moduleId];
                if (!module || module.lessons.length === 0) {
                    lessonModalContent.innerHTML = '<p>Lessons for this module are coming soon!</p>';
                    lessonModalFooter.innerHTML = `<button class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500" onclick="document.getElementById('lesson-modal').classList.add('hidden')">Close</button>`;
                    lessonModal.classList.remove('hidden');
                    return;
                }
                
                const lesson = module.lessons[lessonIndex];
                lessonModalTitle.textContent = lesson.name;
                lessonModalContent.innerHTML = '<div class="text-center p-8">Generating your lesson... <div class="w-8 h-8 border-4 border-gray-500 border-t-cyan-500 rounded-full animate-spin mx-auto mt-4"></div></div>';
                lessonModal.classList.remove('hidden');

                const lessonContent = await generateLessonContent(lesson.name);
                lessonModalContent.innerHTML = lessonContent.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');

                lessonModalFooter.innerHTML = `
                    <button class="mark-lesson-complete-btn px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-500" data-module-id="${moduleId}" data-lesson-id="${lesson.id}">Mark as Complete</button>
                `;
            };

            const generateLessonContent = async (lessonName) => {
                const prompt = `Provide a detailed yet easy-to-understand lesson on the Sanskrit grammar topic: "${lessonName}". Explain the core concepts, rules, and provide at least 3 clear examples with translations. Format the response for clarity.`;
                try {
                    const response = await callGeminiAPI({ contents: [{ role: 'user', parts: [{ text: prompt }] }] });
                    return response || "Could not generate lesson content at this time.";
                } catch (error) {
                    console.error("Error generating lesson content:", error);
                    return "An error occurred while generating the lesson.";
                }
            };

            lessonModal.addEventListener('click', async (e) => {
                if (e.target.matches('.mark-lesson-complete-btn')) {
                    const { moduleId, lessonId } = e.target.dataset;
                    if (!learningProgress[moduleId]) {
                        learningProgress[moduleId] = { lessons: {}, quizzes: {} };
                    }
                    learningProgress[moduleId].lessons[lessonId] = true;
                    await window.firebase.setDoc(getProgressDocRef(), learningProgress);
                    lessonModal.classList.add('hidden');
                }
            });

            lessonModalCloseBtn.addEventListener('click', () => lessonModal.classList.add('hidden'));

            const openQuizSetupModal = (moduleId) => {
                quizSetupTitle.textContent = `Setup ${modules[moduleId].name} Quiz`;
                startQuizFromSetupBtn.dataset.moduleId = moduleId;
                questionCountSlider.value = 10;
                questionCountValue.textContent = 10;
                quizSetupModal.classList.remove('hidden');
            };

            if (quizSetupCloseBtn) quizSetupCloseBtn.addEventListener('click', () => quizSetupModal.classList.add('hidden'));
            if (questionCountSlider) questionCountSlider.addEventListener('input', (e) => {
                questionCountValue.textContent = e.target.value;
            });
            if (startQuizFromSetupBtn) startQuizFromSetupBtn.addEventListener('click', () => {
                const moduleId = startQuizFromSetupBtn.dataset.moduleId;
                const questionCount = parseInt(questionCountSlider.value, 10);
                const difficulty = document.querySelector('input[name="difficulty"]:checked').value;
                const questionType = document.querySelector('input[name="questionType"]:checked').value;
                const quizMode = document.querySelector('input[name="quizMode"]:checked').value;
                quizSetupModal.classList.add('hidden');
                startQuiz(moduleId, questionCount, difficulty, questionType, quizMode);
            });

            const startQuiz = async (moduleId, questionCount, difficulty, questionType, quizMode) => {
                quizModalTitle.textContent = `${modules[moduleId].name} Quiz`;
                quizModalContent.innerHTML = '<div class="text-center p-8">Generating your custom quiz... <div class="w-8 h-8 border-4 border-gray-500 border-t-cyan-500 rounded-full animate-spin mx-auto mt-4"></div></div>';
                quizModal.classList.remove('hidden');

                const questions = await generateQuizQuestions(moduleId, questionCount, difficulty, questionType);
                if (!questions || questions.length === 0) {
                    quizModalContent.innerHTML = '<p class="text-center">Could not generate a quiz at this time. Please try again later.</p>';
                    quizModalFooter.innerHTML = `<button onclick="document.getElementById('quiz-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500">Close</button>`;
                    return;
                }

                currentQuiz = {
                    moduleId,
                    questions,
                    quizMode,
                    currentQuestionIndex: 0,
                    score: 0,
                    userAnswers: []
                };
                displayCurrentQuizQuestion();
            };
            
            const generateQuizQuestions = async (moduleId, questionCount, difficulty, questionType) => {
                let prompt;
                if (questionType === 'mixed') {
                    prompt = `Generate a ${questionCount}-question, ${difficulty}-difficulty quiz about Sanskrit ${modules[moduleId].name}. The quiz should contain a mix of question types: 'single-correct', 'multi-correct', 'fill-in-the-blank', and 'matching'. For each question, provide a detailed explanation for the correct answer and specify its type.`;
                } else {
                    prompt = `Generate a ${questionCount}-question, ${difficulty}-difficulty quiz about Sanskrit ${modules[moduleId].name}. The question type is "${questionType}". For each question, provide a detailed explanation for the correct answer.`;
                }
                
                const responseSchema = {
                    type: "OBJECT",
                    properties: {
                        type: { type: "STRING", description: "The type of question. Can be 'single-correct', 'multi-correct', 'fill-in-the-blank', or 'matching'." },
                        question: { type: "STRING" },
                        explanation: { type: "STRING" },
                        options: { type: "ARRAY", items: { type: "STRING" }, description: "Used for single-correct and multi-correct." },
                        answer: { type: "STRING", description: "Used for single-correct and fill-in-the-blank." },
                        answers: { type: "ARRAY", items: { type: "STRING" }, description: "Used for multi-correct and matching." },
                        prompts: { type: "ARRAY", items: { type: "STRING" }, description: "Used for matching." }
                    },
                    required: ["type", "question", "explanation"]
                };
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { type: "ARRAY", items: responseSchema }
                    }
                };

                try {
                    const resultJson = await callGeminiAPI(payload);
                    return JSON.parse(resultJson);
                } catch (error) {
                    console.error("Error generating quiz:", error);
                    return null;
                }
            };
            
            const displayCurrentQuizQuestion = () => {
                const { questions, currentQuestionIndex } = currentQuiz;
                const question = questions[currentQuestionIndex];
                const questionType = question.type; // Get type from the question object itself
                quizProgressIndicator.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
                
                let contentHTML = `<h4 class="text-lg font-semibold mb-4 font-devanagari">${question.question}</h4>`;
                
                switch (questionType) {
                    case 'single-correct':
                        contentHTML += `<div class="space-y-2">`;
                        question.options.forEach(option => {
                            contentHTML += `<button class="quiz-option w-full text-left p-3 bg-gray-700 rounded-lg border-2 border-transparent hover:border-cyan-500">${option}</button>`;
                        });
                        contentHTML += `</div>`;
                        break;
                    case 'multi-correct':
                        contentHTML += `<div class="space-y-2">`;
                        question.options.forEach(option => {
                            contentHTML += `<label class="quiz-option-multi flex items-center p-3 bg-gray-700 rounded-lg border-2 border-transparent hover:border-cyan-500 cursor-pointer"><input type="checkbox" class="mr-3 h-4 w-4 rounded bg-gray-600 border-gray-500 text-cyan-600 focus:ring-cyan-500"><span>${option}</span></label>`;
                        });
                        contentHTML += `</div>`;
                        break;
                    case 'fill-in-the-blank':
                        const inputType = isNaN(question.answer) ? "text" : "number";
                        contentHTML += `<div><input type="${inputType}" id="fill-in-the-blank-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Type your answer here..."></div>`;
                        break;
                    case 'matching':
                        const shuffledAnswers = [...question.answers].sort(() => Math.random() - 0.5);
                        contentHTML += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                        question.prompts.forEach((prompt, index) => {
                            contentHTML += `<div class="matching-item p-3 bg-gray-700 rounded-lg flex items-center justify-between" data-prompt-index="${index}">
                                <span>${prompt}</span>
                                <select class="matching-select bg-gray-600 rounded p-1">
                                    <option value="">Select...</option>
                                    ${shuffledAnswers.map(ans => `<option value="${ans}">${ans}</option>`).join('')}
                                </select>
                            </div>`;
                        });
                        contentHTML += `</div>`;
                        break;
                }

                quizModalContent.innerHTML = contentHTML;
                quizNextBtn.classList.add('hidden');
                quizReviewBtn.classList.add('hidden');
                quizCloseBtn.classList.add('hidden');
                quizSubmitAnswerBtn.classList.toggle('hidden', questionType === 'single-correct');
            };

            quizModalContent.addEventListener('click', (e) => {
                if (e.target.matches('.quiz-option')) {
                    handleAnswerSubmission(e.target.textContent);
                }
            });
            
            quizSubmitAnswerBtn.addEventListener('click', () => handleAnswerSubmission());

            const handleAnswerSubmission = (selectedAnswer = null) => {
                const { quizMode, questions, currentQuestionIndex } = currentQuiz;
                const questionType = questions[currentQuestionIndex].type;
                
                // 1. Record the answer
                let userAnswer;
                switch (questionType) {
                    case 'single-correct':
                        userAnswer = selectedAnswer;
                        break;
                    case 'multi-correct':
                        userAnswer = Array.from(document.querySelectorAll('.quiz-option-multi input:checked')).map(cb => cb.nextElementSibling.textContent);
                        break;
                    case 'fill-in-the-blank':
                        userAnswer = document.getElementById('fill-in-the-blank-input').value;
                        break;
                    case 'matching':
                        userAnswer = Array.from(document.querySelectorAll('.matching-item')).map(item => item.querySelector('select').value);
                        break;
                }
                currentQuiz.userAnswers[currentQuestionIndex] = userAnswer;

                // 2. Decide next step based on mode
                if (quizMode === 'Practice') {
                    showPracticeFeedback();
                } else { // Test Mode
                    goToNextQuestion();
                }
            };

            const showPracticeFeedback = () => {
                const { questions, currentQuestionIndex, userAnswers } = currentQuiz;
                const question = questions[currentQuestionIndex];
                const questionType = question.type;
                const userAnswer = userAnswers[currentQuestionIndex];
                let isCorrect = false;

                switch (questionType) {
                    case 'single-correct':
                        isCorrect = userAnswer.trim().toLowerCase() === question.answer.trim().toLowerCase();
                        if (isCorrect) currentQuiz.score++;
                        document.querySelectorAll('.quiz-option').forEach(btn => {
                            btn.disabled = true;
                            if (btn.textContent.trim().toLowerCase() === question.answer.trim().toLowerCase()) btn.classList.add('correct');
                            else if (btn.textContent === userAnswer) btn.classList.add('incorrect');
                        });
                        break;
                    case 'multi-correct':
                        const correctAnswers = question.answers.map(a => a.trim().toLowerCase());
                        isCorrect = userAnswer.length === correctAnswers.length && userAnswer.map(a => a.trim().toLowerCase()).every(opt => correctAnswers.includes(opt));
                        if (isCorrect) currentQuiz.score++;
                        document.querySelectorAll('.quiz-option-multi').forEach(label => {
                            const span = label.querySelector('span');
                            const input = label.querySelector('input');
                            input.disabled = true;
                            if (correctAnswers.includes(span.textContent.trim().toLowerCase())) {
                                label.classList.add('correct');
                            } else if (input.checked) {
                                label.classList.add('incorrect');
                            }
                        });
                        break;
                    case 'fill-in-the-blank':
                        const userInput = document.getElementById('fill-in-the-blank-input');
                        isCorrect = userAnswer.trim().toLowerCase() === question.answer.toString().trim().toLowerCase();
                        if (isCorrect) {
                            currentQuiz.score++;
                            userInput.classList.add('bg-green-500/20', 'border-green-500');
                        } else {
                            userInput.classList.add('bg-red-500/20', 'border-red-500');
                        }
                        userInput.disabled = true;
                        break;
                    case 'matching':
                        let correctMatches = 0;
                        document.querySelectorAll('.matching-item').forEach((item, index) => {
                            item.querySelector('select').disabled = true;
                            if (userAnswer[index] && userAnswer[index].trim().toLowerCase() === question.answers[index].trim().toLowerCase()) {
                                item.classList.add('correct');
                                correctMatches++;
                            } else {
                                item.classList.add('incorrect');
                            }
                        });
                        if (correctMatches === question.prompts.length) {
                             currentQuiz.score++;
                        }
                        break;
                }
                
                // Show explanation for practice mode
                const explanationEl = document.createElement('div');
                explanationEl.className = 'mt-4 p-3 bg-gray-700/50 rounded-lg border-l-4 border-cyan-500';
                explanationEl.innerHTML = `<h5 class="font-semibold text-cyan-400">Explanation</h5><p class="text-gray-300">${question.explanation}</p>`;
                quizModalContent.appendChild(explanationEl);

                quizSubmitAnswerBtn.classList.add('hidden');
                if (currentQuestionIndex < questions.length - 1) {
                    quizNextBtn.classList.remove('hidden');
                } else {
                    quizReviewBtn.classList.remove('hidden'); 
                    quizCloseBtn.classList.remove('hidden');
                }
            };

            const goToNextQuestion = () => {
                if (currentQuiz.currentQuestionIndex < currentQuiz.questions.length - 1) {
                    currentQuiz.currentQuestionIndex++;
                    displayCurrentQuizQuestion();
                } else {
                    finishQuiz();
                }
            };
            
            quizNextBtn.addEventListener('click', goToNextQuestion);
            
            const finishQuiz = async () => {
                // Calculate final score for Test Mode
                if (currentQuiz.quizMode === 'Test') {
                    let score = 0;
                    currentQuiz.questions.forEach((q, i) => {
                        const userAnswer = currentQuiz.userAnswers[i];
                        let isCorrect = false;
                        switch (q.type) {
                            case 'single-correct':
                                isCorrect = userAnswer && userAnswer.trim().toLowerCase() === q.answer.trim().toLowerCase();
                                break;
                            case 'multi-correct':
                                const correctAnswers = q.answers.map(a => a.trim().toLowerCase());
                                isCorrect = userAnswer && userAnswer.length === correctAnswers.length && userAnswer.map(a => a.trim().toLowerCase()).every(opt => correctAnswers.includes(opt));
                                break;
                            case 'fill-in-the-blank':
                                isCorrect = userAnswer && userAnswer.trim().toLowerCase() === q.answer.toString().trim().toLowerCase();
                                break;
                            case 'matching':
                                let correctMatches = 0;
                                q.answers.forEach((ans, promptIndex) => {
                                    if (userAnswer && userAnswer[promptIndex] && userAnswer[promptIndex].trim().toLowerCase() === ans.trim().toLowerCase()) {
                                        correctMatches++;
                                    }
                                });
                                isCorrect = correctMatches === q.prompts.length;
                                break;
                        }
                        if (isCorrect) score++;
                    });
                    currentQuiz.score = score;
                }

                const { score, questions, moduleId } = currentQuiz;
                const percentage = (score / questions.length) * 100;
                quizModalContent.innerHTML = `
                    <div class="text-center">
                        <h3 class="text-2xl font-bold">Quiz Complete!</h3>
                        <p class="text-4xl font-bold my-4">${score} / ${questions.length}</p>
                        <p class="text-lg">${percentage.toFixed(0)}% Correct</p>
                    </div>
                `;
                quizNextBtn.classList.add('hidden');
                quizSubmitAnswerBtn.classList.add('hidden');
                quizReviewBtn.classList.remove('hidden');
                quizCloseBtn.classList.remove('hidden');
                
                // Save score
                learningProgress[moduleId] = learningProgress[moduleId] || { lessons: {}, quizzes: {} };
                learningProgress[moduleId].quizzes[Date.now()] = { score, total: questions.length };
                await window.firebase.setDoc(getProgressDocRef(), learningProgress);
            };

            quizReviewBtn.addEventListener('click', () => showQuizReview());
            quizCloseBtn.addEventListener('click', () => quizModal.classList.add('hidden'));

            const showQuizReview = () => {
                quizModalTitle.textContent = "Quiz Review";
                quizModalContent.innerHTML = ''; // Clear previous content
                quizModalContent.classList.add('space-y-4');

                currentQuiz.questions.forEach((q, index) => {
                    const userAnswer = currentQuiz.userAnswers[index];
                    let isCorrect = false;
                    
                    switch (q.type) {
                         case 'single-correct':
                            isCorrect = userAnswer && userAnswer.trim().toLowerCase() === q.answer.trim().toLowerCase();
                            break;
                         case 'multi-correct':
                            const correctAnswers = q.answers.map(a => a.trim().toLowerCase());
                            isCorrect = userAnswer && userAnswer.length === correctAnswers.length && userAnswer.map(a => a.trim().toLowerCase()).every(opt => correctAnswers.includes(opt));
                            break;
                        case 'fill-in-the-blank':
                            isCorrect = userAnswer && userAnswer.trim().toLowerCase() === q.answer.toString().trim().toLowerCase();
                            break;
                        case 'matching':
                             let correctMatches = 0;
                             q.answers.forEach((ans, promptIndex) => {
                                 if (userAnswer && userAnswer[promptIndex] && userAnswer[promptIndex].trim().toLowerCase() === ans.trim().toLowerCase()) {
                                     correctMatches++;
                                 }
                             });
                             isCorrect = correctMatches === q.prompts.length;
                             break;
                    }

                    const reviewItem = document.createElement('div');
                    reviewItem.className = `review-question-item p-4 bg-gray-700/50 rounded-lg border-l-4 ${isCorrect ? 'correct' : 'incorrect'}`;
                    
                    let reviewHTML = `<p class="font-semibold">${index + 1}. ${q.question}</p>`;
                    reviewHTML += `<div class="mt-2 text-sm">`;
                    reviewHTML += `<p><span class="font-medium text-gray-400">Your Answer: </span><span class="${isCorrect ? 'text-green-400' : 'text-red-400'}">${Array.isArray(userAnswer) ? userAnswer.join(', ') : (userAnswer || 'No answer')}</span></p>`;
                    if (!isCorrect) {
                         reviewHTML += `<p><span class="font-medium text-gray-400">Correct Answer: </span><span class="text-green-400">${Array.isArray(q.answers || q.answer) ? (q.answers || [q.answer]).join(', ') : q.answer}</span></p>`;
                    }
                    reviewHTML += `</div>`;
                    reviewHTML += `<div class="mt-2 pt-2 border-t border-gray-600 text-sm text-gray-300">${q.explanation}</div>`;
                    reviewHTML += `</div>`;
                    reviewItem.innerHTML = reviewHTML;
                    quizModalContent.appendChild(reviewItem);
                });

                quizReviewBtn.classList.add('hidden');
                quizCloseBtn.classList.remove('hidden');
            };

            // --- View Switching ---
            if (switchToChatBtn) switchToChatBtn.addEventListener('click', () => {
                dashboardScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');
            });

            if (dashboardMenuBtn) dashboardMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dashboardMenuDropdown.classList.toggle('hidden');
            });
            
            if (dashboardMenuDropdown) dashboardMenuDropdown.addEventListener('click', async (e) => {
                e.preventDefault();
                const courseId = e.target.dataset.courseId;
                if (courseId) {
                    activeCourseId = courseId;
                    await window.firebase.updateDoc(getUserDocRef(), { activeCourseId: courseId });
                    initDashboard();
                    chatScreen.classList.add('hidden');
                    dashboardScreen.classList.remove('hidden');
                    dashboardMenuDropdown.classList.add('hidden');
                }
            });

            document.addEventListener('click', () => {
                if (!dashboardMenuDropdown.classList.contains('hidden')) {
                    dashboardMenuDropdown.classList.add('hidden');
                }
            });
            
            const handlePlayOverview = async (moduleId, button) => {
                if (playingOverviewModuleId === moduleId) {
                    if (audioPlayer.paused) {
                        audioPlayer.play();
                    } else {
                        audioPlayer.pause();
                    }
                    return;
                }
                window.handleStopAudio();
                
                playingOverviewModuleId = moduleId;
                updateOverviewIcons();

                const textToSpeak = modules[moduleId].overview_sanskrit;
                const audioInfo = await callGeminiTTSAPI(textToSpeak);

                if (audioInfo && playingOverviewModuleId === moduleId) {
                    const sampleRate = parseInt(audioInfo.mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioInfo.audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();
                } else {
                    playingOverviewModuleId = null;
                    updateOverviewIcons();
                }
            };

            const updateOverviewIcons = () => {
                document.querySelectorAll('.play-overview-btn').forEach(btn => {
                    const moduleId = btn.dataset.moduleId;
                    if (moduleId === playingOverviewModuleId) {
                         if (!audioPlayer.src || audioPlayer.readyState < 2) { 
                            btn.innerHTML = `<div class="w-5 h-5 border-2 border-gray-400 border-t-white rounded-full animate-spin"></div>`;
                        } else if (!audioPlayer.paused) {
                            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`;
                        } else {
                            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`;
                        }
                    } else {
                        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`;
                    }
                });
            };

            audioPlayer.addEventListener('play', () => {
                if (playingOverviewModuleId) updateOverviewIcons();
            });
             audioPlayer.addEventListener('pause', () => {
                if (playingOverviewModuleId) updateOverviewIcons();
            });
            audioPlayer.addEventListener('ended', () => {
                playingOverviewModuleId = null;
                updateOverviewIcons();
            });

            const openLessonSelectionModal = (moduleId) => {
                lessonSelectionList.innerHTML = ''; // Clear previous content

                if (moduleId) {
                    // --- Show Lessons for a specific module ---
                    const module = modules[moduleId];
                    lessonSelectionTitle.textContent = `Lessons for ${module.name}`;
                    
                    const backButton = document.createElement('button');
                    backButton.className = 'mb-2 text-sm text-cyan-400 hover:underline flex items-center gap-1';
                    backButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg> Back to Modules`;
                    backButton.onclick = () => openLessonSelectionModal(); // Go back to module list
                    lessonSelectionList.appendChild(backButton);

                    if (module.lessons.length === 0) {
                        lessonSelectionList.insertAdjacentHTML('beforeend', '<p class="text-center text-gray-400">Lessons for this module are coming soon.</p>');
                    } else {
                        module.lessons.forEach((lesson, index) => {
                            const isCompleted = learningProgress[moduleId]?.lessons?.[lesson.id];
                            const lessonItem = document.createElement('button');
                            lessonItem.className = 'w-full text-left p-3 bg-gray-700 rounded-lg hover:bg-gray-600 flex justify-between items-center';
                            lessonItem.dataset.moduleId = moduleId;
                            lessonItem.dataset.lessonIndex = index;
                            lessonItem.dataset.type = 'lesson'; // Add type
                            lessonItem.innerHTML = `
                                <span>${lesson.name}</span>
                                ${isCompleted ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>' : ''}
                            `;
                            lessonSelectionList.appendChild(lessonItem);
                        });
                    }
                } else {
                    // --- Show all Modules ---
                    lessonSelectionTitle.textContent = 'Select a Module';
                    for (const id in modules) {
                        const module = modules[id];
                        const moduleItem = document.createElement('button');
                        moduleItem.className = 'w-full text-left p-3 bg-gray-700 rounded-lg hover:bg-gray-600 flex justify-between items-center';
                        moduleItem.dataset.moduleId = id;
                        moduleItem.dataset.type = 'module'; // Add type
                        moduleItem.innerHTML = `
                            <span>${module.name}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        `;
                        lessonSelectionList.appendChild(moduleItem);
                    }
                }
                lessonSelectionModal.classList.remove('hidden');
            };

            lessonSelectionList.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button && (button.dataset.type || button.onclick)) {
                    if (button.onclick) return; // Let the onclick handler for "Back" button work
                    const { moduleId, lessonIndex, type } = button.dataset;
                    if (type === 'module') {
                        openLessonSelectionModal(moduleId); // Re-open modal with lessons
                    } else if (type === 'lesson') {
                        lessonSelectionModal.classList.add('hidden');
                        openLessonModal(moduleId, parseInt(lessonIndex, 10));
                    }
                }
            });

            if(lessonSelectionCloseBtn) lessonSelectionCloseBtn.addEventListener('click', () => lessonSelectionModal.classList.add('hidden'));
            
            // --- Achievements Logic ---
            const renderAchievements = () => {
                achievementsList.innerHTML = '';
                const unlockedAchievements = new Set(learningProgress.achievements || []);

                for (const id in achievementsMasterList) {
                    const achievement = achievementsMasterList[id];
                    const isUnlocked = unlockedAchievements.has(id);
                    
                    const badge = document.createElement('div');
                    badge.className = `achievement-badge p-4 bg-gray-700/50 rounded-lg text-center flex flex-col items-center justify-center transition-all ${isUnlocked ? '' : 'locked'}`;
                    badge.innerHTML = `
                        <div class="text-4xl mb-2">${achievement.icon}</div>
                        <h4 class="font-bold text-white">${achievement.name}</h4>
                        <p class="text-sm text-gray-400">${achievement.desc}</p>
                    `;
                    achievementsList.appendChild(badge);
                }
            };

            if (achievementsBtn) achievementsBtn.addEventListener('click', () => {
                renderAchievements();
                achievementsModal.classList.remove('hidden');
            });
            if (achievementsCloseBtn) achievementsCloseBtn.addEventListener('click', () => achievementsModal.classList.add('hidden'));
            if (exportChatBtn) exportChatBtn.addEventListener('click', () => exportChat());


        });

    </script>

</body>
</html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
